{% extends 'material/material_base.html' %}

{% block material_content %}
<style>
    /* ERP 전용 커스텀 스타일 */
    .form-label { font-weight: 600; font-size: 0.9rem; color: #495057; margin-bottom: 0.4rem; }
    .card { border: none; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05); border-radius: 0.5rem; }
    .card-header { background-color: #fff; border-bottom: 2px solid #f1f3f5; padding: 1.2rem 1.5rem; }
    .bg-light-blue { background-color: #f0f7ff; } /* 입력창 배경색 */
    
    /* 체크박스 영역 스타일 */
    .inspection-box {
        display: flex; align-items: center; justify-content: space-between;
        height: 100%;
        padding: 0.375rem 0.75rem;
        border: 1px solid #ced4da; border-radius: 0.375rem;
        background-color: #fff;
    }
    .inspection-box.active { background-color: #fff3cd; border-color: #ffecb5; } 
</style>

<div class="container-fluid" style="max-width: 1200px;">
    
    <div class="d-flex justify-content-between align-items-center mb-4 pt-3">
        <div>
            <h3 class="fw-bold text-dark">
                <i class="bi bi-box-arrow-in-down text-primary me-2"></i>입고처리
            </h3>
            <span class="text-muted small">여러 품목을 리스트에 담아 한 번에 입고 처리합니다.</span>
        </div>
        <div>
            <a href="{% url 'material:incoming_history' %}" class="btn btn-white border shadow-sm btn-sm hover-shadow">
                <i class="bi bi-clock-history me-1"></i> 입고 이력
            </a>
        </div>
    </div>

    <form method="post" id="incomingForm">
        {% csrf_token %}
        
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light fw-bold text-primary">
                <i class="bi bi-info-circle me-1"></i> 입고 공통 정보 (Header)
            </div>
            <div class="card-body bg-white">
                <div class="row g-3 align-items-center">
                    <div class="col-md-3">
                        <label class="form-label small">입고 일자</label>
                        <input type="date" name="date" class="form-control" value="{{ today|date:'Y-m-d' }}" required>
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label small text-danger">수입검사 대상</label>
                        <div class="inspection-box" id="inspectionBox">
                            <label class="form-check-label small text-muted mb-0 me-2" for="chkInspection" id="lblInspection">미진행</label>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" name="needs_inspection" id="chkInspection" onchange="toggleInspectionMode()" style="cursor: pointer;" checked>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3" id="warehouseCol">
                        <label class="form-label small" id="warehouseLabel">입고 창고 (To)</label>
                        <select name="warehouse_id" id="selWarehouse" class="form-select" required>
                            <option value="">== 창고 선택 ==</option>
                            {% for w in warehouses %}
                                <option value="{{ w.id }}" data-code="{{ w.code }}">{{ w.name }} ({{ w.code }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-3" id="targetWarehouseCol" style="display: none;">
                        <label class="form-label small text-success fw-bold">합격 후 입고 창고</label>
                        <select name="target_warehouse_id" id="selTargetWarehouse" class="form-select border-success">
                            <option value="">== 창고 선택 ==</option>
                            {% for w in warehouses %}
                                <option value="{{ w.id }}" data-code="{{ w.code }}">{{ w.name }} ({{ w.code }})</option>
                            {% endfor %}
                        </select>
                        <div class="form-text small text-success">수입검사 합격 시 입고될 창고</div>
                    </div>

                    <div class="col-md" id="vendorCol">
                        <label class="form-label small">공급처 (Vendor)</label>
                        <div class="input-group">
                            <input type="text" class="form-control bg-light" id="displayVendor" placeholder="업체 선택" readonly onclick="openVendorModal()" style="cursor: pointer;">
                            <button class="btn btn-outline-secondary" type="button" onclick="openVendorModal()">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        <input type="hidden" name="vendor_id" id="hiddenVendorId" required>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-primary mb-4">
            <div class="card-body bg-light-blue">
                <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label class="small fw-bold mb-1 text-primary">입고 품목 검색</label>
                        <input class="form-control" list="partOptions" id="inputPart" placeholder="품번 또는 품명 검색..." autocomplete="off">
                        <datalist id="partOptions">
                            {% for p in parts %}
                                <option data-id="{{ p.id }}" value="{{ p.part_no }}">
                                    {{ p.part_name }} ({{ p.vendor.name }})
                                </option>
                            {% endfor %}
                        </datalist>
                        <input type="hidden" id="selectedPartId">
                        <input type="hidden" id="selectedPartName">
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold mb-1 text-primary">LOT 번호</label>
                        <div class="input-group">
                            <input type="text" id="inputLotNo" class="form-control" placeholder="YYYYMMDD">
                            <button class="btn btn-outline-secondary" type="button" id="btnCalendar" title="달력에서 선택">
                                <i class="bi bi-calendar3"></i>
                            </button>
                            <input type="date" id="hiddenDatePicker" class="d-none">
                        </div>
                    </div>
                    <div class="col-md-1">
                        <label class="small fw-bold mb-1 text-primary">수량</label>
                        <input type="number" id="inputQty" class="form-control text-end fw-bold" placeholder="0" min="1">
                    </div>
                    <div class="col-md-4">
                        <label class="small fw-bold mb-1">비고 (선택)</label>
                        <input type="text" id="inputRemark" class="form-control" placeholder="특이사항 입력">
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-primary w-100 fw-bold" onclick="addItem()">
                            <i class="bi bi-plus-lg"></i> 추가
                        </button>
                    </div>
                </div>
                <div class="form-text mt-2 ms-1 text-success fw-bold" id="partNameDisplay" style="min-height: 20px;"></div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                <span><i class="bi bi-list-check me-1"></i> 입고 대기 목록</span>
                <span class="badge bg-primary rounded-pill" id="itemCount">0건</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle text-center">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 15%;">품번</th>
                                <th class="text-start">품명</th>
                                <th style="width: 12%;">LOT 번호</th>
                                <th style="width: 12%;">수량</th>
                                <th style="width: 20%;">비고</th>
                                <th style="width: 10%;">관리</th>
                            </tr>
                        </thead>
                        <tbody id="listBody">
                            <tr id="emptyRow">
                                <td colspan="6" class="text-muted py-5">
                                    상단에서 품목을 검색하여 <strong>[추가]</strong> 버튼을 눌러주세요.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white text-end py-3">
                <button type="button" class="btn btn-light me-2 px-4" onclick="location.reload()">초기화</button>
                <button type="submit" class="btn btn-success btn-lg px-5 fw-bold shadow-sm" onclick="return validateForm()">
                    <i class="bi bi-save me-2"></i> 입고 처리
                </button>
            </div>
        </div>
    </form>
</div>

<div class="modal fade" id="vendorSearchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold"><i class="bi bi-building me-2"></i>협력사 검색</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="input-group mb-3">
                    <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="vendorSearchInput" placeholder="업체명 또는 코드를 입력하세요..." onkeyup="filterVendors()">
                </div>
                <div class="border rounded" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover mb-0" id="vendorTable">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th width="30%" class="ps-4">업체코드</th>
                                <th>업체명</th>
                                <th width="15%" class="text-center">선택</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for v in vendors %}
                            <tr>
                                <td class="ps-4">{{ v.code }}</td>
                                <td class="vendor-name fw-bold text-dark">{{ v.name }}</td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-outline-primary rounded-pill px-3" 
                                            onclick="selectVendor('{{ v.id }}', '{{ v.name }}', '{{ v.code }}')">
                                        선택
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 페이지 로드 후 실행 (안전한 모달 제어 및 초기화) ---
    document.addEventListener('DOMContentLoaded', function() {
        
        var vendorModalEl = document.getElementById('vendorSearchModal');
        var vendorModal = null;
        if (vendorModalEl) {
            vendorModal = new bootstrap.Modal(vendorModalEl);
        }

        window.openVendorModal = function() {
            if (vendorModal) {
                vendorModal.show();
                setTimeout(() => document.getElementById('vendorSearchInput').focus(), 500);
            } else {
                console.error("모달 요소를 찾을 수 없습니다.");
            }
        };

        window.selectVendor = function(id, name, code) {
            document.getElementById('hiddenVendorId').value = id;
            document.getElementById('displayVendor').value = `[${code}] ${name}`;
            if (vendorModal) vendorModal.hide();
        };

        // ✅ [추가] 페이지 로드 시 수입검사 모드 초기 실행 (노란색 디자인 적용 및 창고 자동선택)
        toggleInspectionMode();

        // ✅ [LOT 입력 기능] 오늘 날짜 기본값 설정
        setTodayAsDefault();

        // ✅ [LOT 입력 기능] 숫자 입력 자동 포맷팅 (20260504 → 2026-05-04)
        document.getElementById('inputLotNo').addEventListener('input', formatLotInput);

        // ✅ [LOT 입력 기능] 달력 버튼 클릭 시 date picker 열기
        document.getElementById('btnCalendar').addEventListener('click', openDatePicker);

        // ✅ [LOT 입력 기능] hidden date picker에서 날짜 선택 시 text input에 반영
        document.getElementById('hiddenDatePicker').addEventListener('change', function() {
            const selectedDate = this.value;
            if (selectedDate) {
                document.getElementById('inputLotNo').value = selectedDate;
            }
        });
    });

    // --- 업체 필터링 ---
    function filterVendors() {
        const input = document.getElementById('vendorSearchInput');
        const filter = input.value.toUpperCase();
        const table = document.getElementById('vendorTable');
        const tr = table.getElementsByTagName('tr');

        for (let i = 1; i < tr.length; i++) {
            let tdCode = tr[i].getElementsByTagName('td')[0];
            let tdName = tr[i].getElementsByTagName('td')[1];
            if (tdCode || tdName) {
                let txtValueCode = tdCode.textContent || tdCode.innerText;
                let txtValueName = tdName.textContent || tdName.innerText;
                if (txtValueCode.toUpperCase().indexOf(filter) > -1 || txtValueName.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }

    // --- 수입검사 체크박스 효과 ---
    function toggleInspectionMode() {
        const checkBox = document.getElementById('chkInspection');
        const box = document.getElementById('inspectionBox');
        const label = document.getElementById('lblInspection');
        const select = document.getElementById('selWarehouse');
        const targetCol = document.getElementById('targetWarehouseCol');
        const targetSelect = document.getElementById('selTargetWarehouse');
        const warehouseLabel = document.getElementById('warehouseLabel');

        if (checkBox.checked) {
            box.classList.add('active');
            label.innerText = "진행 (On)";
            label.classList.remove('text-muted');
            label.classList.add('text-danger', 'fw-bold');

            // 검사대기장 자동 선택
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].text.includes("검사")) {
                    select.selectedIndex = i;
                    break;
                }
            }

            // 합격 후 입고 창고 필드 표시
            targetCol.style.display = '';
            warehouseLabel.textContent = '검사 대기 창고';

            // 원재료 창고 자동 선택 (기본값)
            for (let i = 0; i < targetSelect.options.length; i++) {
                if (targetSelect.options[i].text.includes("원재료") || targetSelect.options[i].getAttribute('data-code') === '3000') {
                    targetSelect.selectedIndex = i;
                    break;
                }
            }
        } else {
            box.classList.remove('active');
            label.innerText = "미진행";
            label.classList.add('text-muted');
            label.classList.remove('text-danger', 'fw-bold');

            // 자재창고 자동 선택
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].text.includes("자재")) {
                    select.selectedIndex = i;
                    break;
                }
            }

            // 합격 후 입고 창고 필드 숨김
            targetCol.style.display = 'none';
            targetSelect.value = '';
            warehouseLabel.textContent = '입고 창고 (To)';
        }
    }

    // --- 품목 검색 및 매핑 ---
    document.getElementById('inputPart').addEventListener('input', function() {
        var val = this.value;
        var options = document.getElementById('partOptions').options;
        var found = false;
        
        for (var i = 0; i < options.length; i++) {
            if (options[i].value === val) {
                document.getElementById('selectedPartId').value = options[i].getAttribute('data-id');
                var fullText = options[i].innerText.trim();
                document.getElementById('selectedPartName').value = fullText;
                document.getElementById('partNameDisplay').innerHTML = `<i class="bi bi-check-circle-fill me-1"></i> ${fullText}`;
                found = true;
                break;
            }
        }
        if (!found) {
            document.getElementById('selectedPartId').value = '';
            document.getElementById('selectedPartName').value = '';
            document.getElementById('partNameDisplay').innerText = '';
        }
    });

    // --- 리스트 추가 로직 ---
    function addItem() {
        var partId = document.getElementById('selectedPartId').value;
        var partNo = document.getElementById('inputPart').value;
        var partName = document.getElementById('selectedPartName').value;
        var lotNo = document.getElementById('inputLotNo').value;
        var qty = document.getElementById('inputQty').value;
        var remark = document.getElementById('inputRemark').value;

        if (!partId || !partNo) {
            alert("유효한 품목을 선택해주세요.");
            document.getElementById('inputPart').focus();
            return;
        }
        if (!qty || parseInt(qty) <= 0) {
            alert("수량을 1개 이상 입력해주세요.");
            document.getElementById('inputQty').focus();
            return;
        }

        var emptyRow = document.getElementById('emptyRow');
        if (emptyRow) emptyRow.remove();

        var tbody = document.getElementById('listBody');
        var newRow = document.createElement('tr');

        var lotDisplay = lotNo ? lotNo : '-';

        var html = `
            <td class="fw-bold text-primary">
                ${partNo}
                <input type="hidden" name="part_ids[]" value="${partId}">
            </td>
            <td class="text-start ps-3">${partName}</td>
            <td class="text-center">
                ${lotDisplay}
                <input type="hidden" name="lot_nos[]" value="${lotNo}">
            </td>
            <td class="fw-bold fs-5 text-end pe-4">
                ${parseInt(qty).toLocaleString()}
                <input type="hidden" name="quantities[]" value="${qty}">
            </td>
            <td class="text-muted small">
                ${remark}
                <input type="hidden" name="remarks[]" value="${remark}">
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;

        newRow.innerHTML = html;
        tbody.appendChild(newRow);

        document.getElementById('inputPart').value = '';
        document.getElementById('selectedPartId').value = '';
        document.getElementById('selectedPartName').value = '';
        document.getElementById('partNameDisplay').innerText = '';
        setTodayAsDefault(); // LOT 번호를 오늘 날짜로 리셋
        document.getElementById('inputQty').value = '';
        document.getElementById('inputRemark').value = '';
        document.getElementById('inputPart').focus();

        updateCount();
    }

    function removeRow(btn) {
        btn.closest('tr').remove();
        var tbody = document.getElementById('listBody');
        if (tbody.children.length === 0) {
            tbody.innerHTML = `<tr id="emptyRow"><td colspan="6" class="text-muted py-5">상단에서 품목을 검색하여 <strong>[추가]</strong> 버튼을 눌러주세요.</td></tr>`;
        }
        updateCount();
    }

    function updateCount() {
        var count = document.querySelectorAll('input[name="part_ids[]"]').length;
        document.getElementById('itemCount').innerText = count + "건";
    }

    function validateForm() {
        var count = document.querySelectorAll('input[name="part_ids[]"]').length;
        if (count === 0) {
            alert("입고할 품목을 최소 1개 이상 추가해주세요.");
            return false;
        }

        var wh = document.querySelector('select[name="warehouse_id"]').value;
        var vendor = document.querySelector('input[name="vendor_id"]').value;

        if (!wh) { alert("입고 창고를 선택해주세요."); return false; }
        if (!vendor) { alert("공급처(Vendor)를 선택해주세요."); return false; }

        var inspection = document.getElementById('chkInspection').checked;
        var targetWh = document.querySelector('select[name="target_warehouse_id"]').value;
        if (inspection && !targetWh) { alert("합격 후 입고 창고를 선택해주세요."); return false; }

        return confirm("총 " + count + "건의 자재를 입고 처리하시겠습니까?");
    }

    // --- LOT 입력 관련 기능 ---

    // 1. 오늘 날짜를 기본값으로 설정
    function setTodayAsDefault() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const todayStr = `${year}-${month}-${day}`;

        document.getElementById('inputLotNo').value = todayStr;
        document.getElementById('hiddenDatePicker').value = todayStr;
    }

    // 2. 숫자 입력 자동 포맷팅 (20260504 → 2026-05-04)
    function formatLotInput(e) {
        let value = e.target.value;

        // 숫자와 하이픈만 허용
        value = value.replace(/[^\d-]/g, '');

        // 이미 YYYY-MM-DD 형식이면 그대로 유지
        if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
            return;
        }

        // 숫자만 추출
        const digitsOnly = value.replace(/-/g, '');

        // 8자리 숫자 입력 시 자동 포맷팅
        if (digitsOnly.length === 8) {
            const formatted = `${digitsOnly.substring(0, 4)}-${digitsOnly.substring(4, 6)}-${digitsOnly.substring(6, 8)}`;

            // 날짜 유효성 검사
            const testDate = new Date(formatted);
            if (!isNaN(testDate.getTime())) {
                e.target.value = formatted;
                document.getElementById('hiddenDatePicker').value = formatted;
            } else {
                alert('올바른 날짜 형식이 아닙니다. (예: 20260504)');
                e.target.value = '';
            }
        } else {
            // 8자리 미만은 그대로 표시 (입력 중)
            e.target.value = value;
        }
    }

    // 3. 달력 버튼 클릭 시 date picker 열기
    function openDatePicker() {
        const hiddenPicker = document.getElementById('hiddenDatePicker');
        const currentValue = document.getElementById('inputLotNo').value;

        // 현재 입력값이 YYYY-MM-DD 형식이면 date picker에 설정
        if (/^\d{4}-\d{2}-\d{2}$/.test(currentValue)) {
            hiddenPicker.value = currentValue;
        }

        // date picker 클릭 (브라우저 기본 달력 UI 표시)
        hiddenPicker.click();
    }
</script>
{% endblock %}