{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ÏõêÏû¨Î£å ÎùºÎ≤® Ï∂úÎ†•</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: "Malgun Gothic", sans-serif;
            background: #555;
        }

        /* ===== ÏÉÅÎã® ÏÑ§Ï†ï ÏòÅÏó≠ ===== */
        .no-print {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .toolbar-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .print-info { font-size: 14pt; }
        .print-info strong { color: #f39c12; }

        .btn-group-actions {
            display: flex;
            gap: 10px;
        }

        .toolbar-options {
            display: flex;
            gap: 20px;
            align-items: center;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px 15px;
        }

        .option-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-group > label {
            font-size: 9pt;
            color: #bdc3c7;
            white-space: nowrap;
        }

        .mode-btn {
            padding: 6px 14px;
            border: 2px solid #555;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 9pt;
            background: transparent;
            color: #bdc3c7;
            transition: all 0.15s;
        }

        .mode-btn.active {
            border-color: #f39c12;
            background: #f39c12;
            color: #000;
        }

        .mode-btn:hover:not(.active) {
            border-color: #95a5a6;
            color: white;
        }

        .size-select {
            padding: 6px 10px;
            border-radius: 5px;
            border: 2px solid #555;
            background: #34495e;
            color: white;
            font-size: 9pt;
            font-weight: bold;
            cursor: pointer;
        }

        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 11pt;
            transition: all 0.15s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
        }

        .btn-print { background: #27ae60; color: #fff; }
        .btn-print:hover { background: #219a52; }
        .btn-back { background: #95a5a6; color: #fff; }
        .btn-back:hover { background: #7f8c8d; }

        /* ===== ÎØ∏Î¶¨Î≥¥Í∏∞ Ïª®ÌÖåÏù¥ÎÑà ===== */
        #preview-container {
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        #preview-container.sheet-mode {
            gap: 3mm;
            padding: 10px;
        }

        /* ===== ÎùºÎ≤® Ïπ¥Îìú ===== */
        .label {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 2px solid #000;
            display: flex;
            flex-direction: column;
        }

        /* ÌÅ¨Í∏∞Î≥Ñ ÎùºÎ≤® */
        .label.size-small  { width: 60mm; height: 40mm; }
        .label.size-medium { width: 80mm; height: 50mm; }
        .label.size-large  { width: 100mm; height: 70mm; }

        /* ÎùºÎ≤® Ï†úÎ™© */
        .label-title {
            font-weight: bold;
            text-align: center;
            border-bottom: 2px solid #000;
            background: #f0f0f0;
            letter-spacing: 2px;
        }
        .size-small .label-title  { font-size: 8pt; padding: 2px; }
        .size-medium .label-title { font-size: 11pt; padding: 4px; }
        .size-large .label-title  { font-size: 13pt; padding: 6px; }

        /* ÎùºÎ≤® Î∞îÎîî */
        .label-body {
            display: flex;
            flex: 1;
        }
        .size-small .label-body  { padding: 1.5mm 2mm; gap: 2mm; }
        .size-medium .label-body { padding: 2mm 3mm; gap: 3mm; }
        .size-large .label-body  { padding: 3mm 4mm; gap: 4mm; }

        /* QR ÏΩîÎìú ÏòÅÏó≠ */
        .qr-area {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .qr-area img, .qr-area canvas {
            max-width: 100% !important;
            max-height: 100% !important;
        }
        .size-small .qr-area  { width: 16mm; height: 16mm; }
        .size-medium .qr-area { width: 23mm; height: 23mm; }
        .size-large .qr-area  { width: 30mm; height: 30mm; }

        /* Ï†ïÎ≥¥ ÏòÅÏó≠ */
        .info-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .size-small .info-area  { gap: 0.3mm; }
        .size-medium .info-area { gap: 0.5mm; }
        .size-large .info-area  { gap: 1mm; }

        .info-row {
            display: flex;
            align-items: baseline;
            gap: 2mm;
        }

        .info-label {
            color: #555;
            font-weight: bold;
            flex-shrink: 0;
        }
        .size-small .info-label  { font-size: 5.5pt; width: 8mm; }
        .size-medium .info-label { font-size: 7pt; width: 10mm; }
        .size-large .info-label  { font-size: 8pt; width: 12mm; }

        .info-value { font-weight: bold; }
        .size-small .info-value  { font-size: 7pt; }
        .size-medium .info-value { font-size: 9pt; }
        .size-large .info-value  { font-size: 11pt; }

        .size-small .part-no  { font-size: 9pt !important; font-family: monospace; }
        .size-medium .part-no { font-size: 14pt !important; font-family: monospace; letter-spacing: 0.5px; }
        .size-large .part-no  { font-size: 16pt !important; font-family: monospace; letter-spacing: 0.5px; }

        .size-small .part-name  { font-size: 6pt !important; font-weight: normal !important; max-width: 28mm; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .size-medium .part-name { font-size: 8pt !important; font-weight: normal !important; max-width: 38mm; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .size-large .part-name  { font-size: 9pt !important; font-weight: normal !important; max-width: 50mm; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .size-small .qty-value  { font-size: 9pt !important; color: #c0392b; }
        .size-medium .qty-value { font-size: 12pt !important; color: #c0392b; }
        .size-large .qty-value  { font-size: 14pt !important; color: #c0392b; }

        /* ÎùºÎ≤® Ìë∏ÌÑ∞ */
        .label-footer {
            border-top: 1px dashed #999;
            text-align: center;
            background: #fafafa;
        }
        .size-small .label-footer  { padding: 1px; }
        .size-medium .label-footer { padding: 2px; }
        .size-large .label-footer  { padding: 3px; }

        .label-id {
            font-family: 'Consolas', monospace;
            color: #333;
            font-weight: bold;
            letter-spacing: 0.5px;
        }
        .size-small .label-id  { font-size: 6pt; }
        .size-medium .label-id { font-size: 8pt; }
        .size-large .label-id  { font-size: 9pt; }

        /* Îπà ÏÉÅÌÉú */
        .empty-state {
            color: white;
            text-align: center;
            padding: 50px;
            width: 100%;
        }
        .empty-state p { font-size: 18pt; margin-bottom: 15px; }
        .empty-state a { color: #3498db; }

        /* Ïù∏ÏáÑ Í∏∞Î≥∏ (no-print Ïà®Í∏∞Í∏∞) */
        @media print {
            body { background: white; margin: 0; padding: 0; }
            .no-print { display: none !important; }
        }
    </style>

    <!-- ÎèôÏ†Å Ïù∏ÏáÑ Ïä§ÌÉÄÏùº (JSÏóêÏÑú ÍµêÏ≤¥) -->
    <style id="dynamic-print-style">
        @media print {
            @page { size: 80mm 50mm; margin: 0; }
            #preview-container {
                display: block;
                padding: 0;
                margin: 0;
            }
            .label {
                width: 80mm !important;
                height: 50mm !important;
                box-shadow: none;
                page-break-after: always;
                margin: 0;
            }
            .label:last-child { page-break-after: auto; }
        }
    </style>
</head>
<body>

    <!-- ÏÉÅÎã® ÏÑ§Ï†ï -->
    <div class="no-print">
        <div class="toolbar-top">
            <div class="print-info">
                üè∑Ô∏è <strong>ÏõêÏû¨Î£å ÎùºÎ≤® Ï∂úÎ†•</strong>
                <span style="margin-left: 20px;">Ï¥ù <strong>{{ labels|length }}Ïû•</strong></span>
                <span id="sizeInfo" style="margin-left: 15px; font-size: 10pt; color: #bdc3c7;">80mm √ó 50mm</span>
            </div>
            <div class="btn-group-actions">
                <button onclick="window.print()" class="btn btn-print">üñ®Ô∏è Ïù∏ÏáÑ</button>
                <a href="{% url 'material:raw_material_incoming' %}" class="btn btn-back">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</a>
            </div>
        </div>
        <div class="toolbar-options">
            <div class="option-group">
                <label>ÌîÑÎ¶∞ÌÑ∞:</label>
                <button type="button" class="mode-btn active" data-mode="roll" onclick="setPrintMode('roll')">üè∑Ô∏è ÎùºÎ≤® ÌîÑÎ¶∞ÌÑ∞</button>
                <button type="button" class="mode-btn" data-mode="sheet" onclick="setPrintMode('sheet')">üìÑ A4 ÌîÑÎ¶∞ÌÑ∞</button>
            </div>
            <div class="option-group">
                <label>ÎùºÎ≤® ÌÅ¨Í∏∞:</label>
                <select class="size-select" id="sizeSelect" onchange="setLabelSize(this.value)">
                    <option value="small">ÏÜåÌòï (60√ó40mm)</option>
                    <option value="medium" selected>ÌëúÏ§Ä (80√ó50mm)</option>
                    <option value="large">ÎåÄÌòï (100√ó70mm)</option>
                </select>
            </div>
            <div class="option-group" id="sheetInfo" style="display:none;">
                <span style="font-size: 9pt; color: #f39c12;">üìã A4 1ÌéòÏù¥ÏßÄÎãπ <strong id="perPageCount">10</strong>Ïû•</span>
            </div>
        </div>
    </div>

    <!-- ÎùºÎ≤® ÎØ∏Î¶¨Î≥¥Í∏∞ -->
    <div id="preview-container">
        {% for label in labels %}
        <div class="label size-medium">
            <div class="label-title">ÏõêÏû¨Î£å ÏûÖÍ≥† ÎùºÎ≤®</div>
            <div class="label-body">
                <div class="qr-area" id="qr_{{ forloop.counter0 }}"></div>
                <div class="info-area">
                    <div class="info-row">
                        <span class="info-label">ÌíàÎ≤à</span>
                        <span class="info-value part-no">{{ label.part_no }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ÌíàÎ™Ö</span>
                        <span class="info-value part-name" title="{{ label.part_name }}">{{ label.part_name }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">LOT</span>
                        <span class="info-value">{{ label.lot_no|date:"Y-m-d" }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ÏàòÎüâ</span>
                        <span class="info-value qty-value">{{ label.quantity }}{{ label.get_unit_display }}</span>
                    </div>
                    {% if label.expiry_date %}
                    <div class="info-row">
                        <span class="info-label">Ïú†Ìö®</span>
                        <span class="info-value">{{ label.expiry_date|date:"Y-m-d" }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="label-footer">
                <span class="label-id">{{ label.label_id }}</span>
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            <p>Ï∂úÎ†•Ìï† ÎùºÎ≤®Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
            <a href="{% url 'material:raw_material_incoming' %}">ÏûÖÍ≥† ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô</a>
        </div>
        {% endfor %}
    </div>

    <script>
        // ===== ÎùºÎ≤® ÌÅ¨Í∏∞ ÏÑ§Ï†ï =====
        const SIZES = {
            small:  { w: 60,  h: 40, qr: 55,  display: '60mm √ó 40mm' },
            medium: { w: 80,  h: 50, qr: 80,  display: '80mm √ó 50mm' },
            large:  { w: 100, h: 70, qr: 110, display: '100mm √ó 70mm' }
        };

        let currentMode = 'roll';
        let currentSize = 'medium';

        // ===== ÌîÑÎ¶∞ÌÑ∞ Î™®Îìú Î≥ÄÍ≤Ω =====
        function setPrintMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            document.getElementById('sheetInfo').style.display = (mode === 'sheet') ? '' : 'none';
            document.getElementById('preview-container').classList.toggle('sheet-mode', mode === 'sheet');
            updatePrintStyle();
        }

        // ===== ÎùºÎ≤® ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω =====
        function setLabelSize(size) {
            currentSize = size;
            const s = SIZES[size];

            // ÎùºÎ≤® ÌÅ¨Í∏∞ ÌÅ¥ÎûòÏä§ Î≥ÄÍ≤Ω
            document.querySelectorAll('.label').forEach(el => {
                el.className = el.className.replace(/size-\w+/, 'size-' + size);
            });

            // ÌÅ¨Í∏∞ Ï†ïÎ≥¥ ÌëúÏãú
            document.getElementById('sizeInfo').textContent = s.display;

            // QR Ïû¨ÏÉùÏÑ±
            regenerateQR(s.qr);
            updatePrintStyle();
        }

        // ===== ÎèôÏ†Å Ïù∏ÏáÑ Ïä§ÌÉÄÏùº ÏóÖÎç∞Ïù¥Ìä∏ =====
        function updatePrintStyle() {
            const s = SIZES[currentSize];
            const styleEl = document.getElementById('dynamic-print-style');
            let css = '';

            if (currentMode === 'sheet') {
                // A4 Î™®ÏïÑÏ∞çÍ∏∞
                const cols = Math.floor((200 + 3) / (s.w + 3));
                const rows = Math.floor((287 + 3) / (s.h + 3));
                const perPage = cols * rows;
                document.getElementById('perPageCount').textContent = perPage;

                css = `
                @media print {
                    @page { size: A4; margin: 5mm; }
                    #preview-container {
                        display: grid !important;
                        grid-template-columns: repeat(${cols}, ${s.w}mm) !important;
                        gap: 3mm !important;
                        padding: 0 !important;
                        margin: 0 !important;
                        width: 100% !important;
                    }
                    .label {
                        width: ${s.w}mm !important;
                        height: ${s.h}mm !important;
                        box-shadow: none !important;
                        page-break-inside: avoid !important;
                        margin: 0 !important;
                    }
                }`;
            } else {
                // ÎùºÎ≤® ÌîÑÎ¶∞ÌÑ∞ - 1Ïû•Ïî©
                css = `
                @media print {
                    @page { size: ${s.w}mm ${s.h}mm; margin: 0; }
                    #preview-container {
                        display: block !important;
                        padding: 0 !important;
                        margin: 0 !important;
                    }
                    .label {
                        width: ${s.w}mm !important;
                        height: ${s.h}mm !important;
                        box-shadow: none !important;
                        page-break-after: always !important;
                        margin: 0 !important;
                    }
                    .label:last-child {
                        page-break-after: auto !important;
                    }
                }`;
            }

            styleEl.textContent = css;
        }

        // ===== QR ÏΩîÎìú Ïû¨ÏÉùÏÑ± =====
        function regenerateQR(qrPixels) {
            labelList.forEach(label => {
                const el = document.getElementById('qr_' + label.index);
                if (el) {
                    el.innerHTML = '';
                    const qrData = label.label_id + '|' + label.part_no + '|' + label.quantity + label.unit + '|' + label.lot_no;
                    new QRCode(el, {
                        text: qrData,
                        width: qrPixels,
                        height: qrPixels,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.M
                    });
                }
            });
        }

        // ===== QR Îç∞Ïù¥ÌÑ∞ =====
        const labelList = [
            {% for label in labels %}
            {
                index: {{ forloop.counter0 }},
                label_id: "{{ label.label_id }}",
                part_no: "{{ label.part_no }}",
                quantity: "{{ label.quantity }}",
                unit: "{{ label.get_unit_display }}",
                lot_no: "{{ label.lot_no|date:'Y-m-d' }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        // Ï¥àÍ∏∞ QR ÏÉùÏÑ±
        regenerateQR(SIZES[currentSize].qr);
    </script>
</body>
</html>
