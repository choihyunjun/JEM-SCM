{% extends 'material/material_base.html' %}

{% block material_content %}
<div class="container-fluid" style="max-width: 1800px;">
    <div class="d-flex justify-content-between align-items-center mb-4 pt-3">
        <h3 class="fw-bold text-dark">
            <i class="bi bi-arrow-left-right text-success me-2"></i>재고 이동 처리
        </h3>
        <span class="text-muted small">창고 간 재고를 이동하고 수불 이력을 생성합니다.</span>
    </div>

    <form method="post" id="transferForm">
        {% csrf_token %}

        <div class="card shadow-sm border-success mb-4">
            <div class="card-header bg-success text-white fw-bold">
                <i class="bi bi-plus-circle me-1"></i> 이동 대상 추가
            </div>
            <div class="card-body bg-light">
                <!-- 이동 처리일 + QR 스캔 입력란 -->
                <div class="row g-2 mb-3">
                    <div class="col-md-2">
                        <label class="small fw-bold mb-1 text-dark">
                            <i class="bi bi-calendar-date me-1"></i>이동 처리일
                        </label>
                        <input type="date" name="transfer_date" id="transferDate"
                               class="form-control fw-bold" value="{{ today }}">
                    </div>
                    <div class="col-md-10">
                        <label class="small fw-bold mb-1 text-primary">
                            <i class="bi bi-qr-code-scan me-1"></i>QR 코드 스캔 (빠른 입력)
                        </label>
                        <input type="text" id="qrScanInput" class="form-control form-control-lg border-primary"
                               placeholder="현품표 QR 코드를 스캔하세요"
                               autocomplete="off"
                               style="background: #f0f8ff; font-weight: bold;">
                    </div>
                </div>
                <small class="text-muted d-block mb-2">
                    <i class="bi bi-info-circle"></i> QR 코드를 스캔하면 품번, 수량, LOT가 자동으로 입력됩니다. 이동 처리일을 과거 날짜로 설정하면 해당 일자로 이력이 생성됩니다.
                </small>

                <hr class="my-3">

                <!-- 수동 입력란 -->
                <div class="row g-2 align-items-end">

                    <div class="col-md-3 position-relative">
                        <label class="small fw-bold mb-1">품번 (Part No)</label>
                        <input type="text" id="inputPart" class="form-control" placeholder="품번/품명 검색" autocomplete="off">
                        <div id="partSearchDropdown" class="position-absolute w-100 bg-white border rounded shadow-sm"
                             style="display:none; z-index:1050; max-height:280px; overflow-y:auto; top:100%;"></div>
                    </div>

                    <div class="col-md-2">
                        <label class="small fw-bold mb-1">보내는 창고 (From)</label>
                        <select id="selFromLoc" class="form-select">
                            <option value="">:: 선택 ::</option>
                            {% for loc in warehouses %}
                            <option value="{{ loc.code }}">({{ loc.code }}) {{ loc.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="small fw-bold mb-1">LOT 선택 <span class="text-danger">*</span></label>
                        <select id="selLot" class="form-select" disabled>
                            <option value="">:: 품번/창고 선택 후 표시 ::</option>
                        </select>
                    </div>

                    <div class="col-md-1 d-flex align-items-end">
                        <small id="lotInfo" class="text-muted"></small>
                    </div>

                    <div class="col-md-2">
                        <label class="small fw-bold mb-1">받는 창고 (To)</label>
                        <select id="selToLoc" class="form-select">
                            <option value="">:: 선택 ::</option>
                            {% for loc in warehouses %}
                            <option value="{{ loc.code }}">({{ loc.code }}) {{ loc.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-1">
                        <label class="small fw-bold mb-1">수량</label>
                        <input type="number" id="inputQty" class="form-control text-end fw-bold" placeholder="0" min="1">
                    </div>

                    <div class="col-md-1">
                        <button type="button" class="btn btn-success w-100 fw-bold" onclick="addRow()">
                            추가
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                <span><i class="bi bi-list-check me-1"></i> 이동 목록</span>
                <span class="badge bg-secondary rounded-pill" id="itemCount">0건</span>
            </div>
            <div class="card-body p-0">
                <table class="table table-bordered table-hover mb-0 text-center align-middle" id="transferTable">
                    <thead class="table-light">
                        <tr>
                            <th width="15%">품번</th>
                            <th width="15%">LOT 번호</th>
                            <th width="20%">보내는 곳 (From)</th>
                            <th width="5%">➡</th>
                            <th width="20%">받는 곳 (To)</th>
                            <th width="10%">수량</th>
                            <th width="10%">삭제</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr id="emptyRow">
                            <td colspan="7" class="text-muted py-4">이동할 항목을 상단에서 추가해주세요.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="card-footer bg-white text-end py-3">
                <button type="button" class="btn btn-light me-2" onclick="location.reload()">초기화</button>
                <button type="submit" class="btn btn-primary btn-lg px-5 fw-bold" onclick="return confirm('작성된 내용으로 재고 이동을 확정하시겠습니까?')">
                    <i class="bi bi-check-circle me-2"></i> 이동 확정
                </button>
            </div>
        </div>
    </form>

    <!-- ============================================ -->
    <!-- 이동 처리 내역 -->
    <!-- ============================================ -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
            <span><i class="bi bi-clock-history me-1"></i> 이동 처리 내역</span>
            <span class="badge bg-success rounded-pill">{{ history_count }}건</span>
        </div>
        <div class="card-body pb-2">
            <form method="get" class="row g-2 align-items-end mb-3">
                <div class="col-md-2">
                    <label class="small fw-bold mb-1">시작일</label>
                    <input type="date" name="hstart" class="form-control form-control-sm" value="{{ hstart }}">
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold mb-1">종료일</label>
                    <input type="date" name="hend" class="form-control form-control-sm" value="{{ hend }}">
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold mb-1">창고</label>
                    <select name="hwh" class="form-select form-select-sm">
                        <option value="">전체</option>
                        {% for loc in warehouses %}
                        <option value="{{ loc.code }}" {% if hwh == loc.code|stringformat:"s" %}selected{% endif %}>({{ loc.code }}) {{ loc.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold mb-1">검색 (품번/품명/수불번호)</label>
                    <input type="text" name="hq" class="form-control form-control-sm" value="{{ hq }}" placeholder="검색어 입력">
                </div>
                <div class="col-md-1">
                    <button type="submit" class="btn btn-dark btn-sm w-100">
                        <i class="bi bi-search"></i> 조회
                    </button>
                </div>
                <div class="col-md-1">
                    <a href="{% url 'material:stock_move' %}" class="btn btn-outline-secondary btn-sm w-100">초기화</a>
                </div>
            </form>
        </div>

        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle text-center">
                <thead class="table-light">
                    <tr>
                        <th style="width:11%;">일시</th>
                        <th style="width:15%;">수불번호</th>
                        <th style="width:9%;">품번</th>
                        <th>품명</th>
                        <th style="width:7%;">수량</th>
                        <th style="width:8%;">LOT</th>
                        <th style="width:12%;">From</th>
                        <th style="width:3%;">→</th>
                        <th style="width:12%;">To</th>
                        <th style="width:5%;">라벨</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trx in history %}
                    <tr style="cursor:pointer;" onclick="openTransferDetail({{ trx.pk }})">
                        <td class="small">{{ trx.date|date:"Y-m-d H:i" }}</td>
                        <td>
                            <a href="javascript:void(0)" class="fw-bold text-primary text-decoration-none">{{ trx.transaction_no }}</a>
                        </td>
                        <td class="fw-bold">{{ trx.part.part_no }}</td>
                        <td class="small text-start">{{ trx.part.part_name|truncatechars:20 }}</td>
                        <td class="fw-bold text-end">{{ trx.quantity|floatformat:0 }}</td>
                        <td class="small">{{ trx.lot_no|date:"Y-m-d"|default:"-" }}</td>
                        <td class="small">{{ trx.warehouse_from.name|default:"-"|truncatechars:12 }}</td>
                        <td class="text-muted">→</td>
                        <td class="small">{{ trx.warehouse_to.name|default:"-"|truncatechars:12 }}</td>
                        <td>
                            {% if trx.label_count > 0 %}
                            <span class="badge bg-warning text-dark"><i class="bi bi-tags"></i> {{ trx.label_count }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="10" class="text-muted py-4">이동 처리 내역이 없습니다.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 페이지네이션 -->
        {% if history.has_other_pages %}
        <div class="card-footer bg-white d-flex justify-content-center py-2">
            <nav>
                <ul class="pagination pagination-sm mb-0">
                    {% if history.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ history.previous_page_number }}&hstart={{ hstart }}&hend={{ hend }}&hwh={{ hwh }}&hq={{ hq }}">이전</a>
                    </li>
                    {% endif %}
                    {% for num in history.paginator.page_range %}
                        {% if history.number == num %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% elif num > history.number|add:"-3" and num < history.number|add:"4" %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}&hstart={{ hstart }}&hend={{ hend }}&hwh={{ hwh }}&hq={{ hq }}">{{ num }}</a>
                        </li>
                        {% endif %}
                    {% endfor %}
                    {% if history.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ history.next_page_number }}&hstart={{ hstart }}&hend={{ hend }}&hwh={{ hwh }}&hq={{ hq }}">다음</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- 라벨 선택 모달 (제조현장 이동 시) -->
<div class="modal fade" id="labelSelectModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-tags me-2"></i>투입 라벨 선택
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info small mb-3">
                    <i class="bi bi-info-circle me-1"></i>
                    제조현장으로 이동하는 품목입니다. 투입할 라벨을 선택해주세요.
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-bold" id="labelModalPartInfo"></span>
                    <div>
                        <span class="text-muted small me-2">이동수량: <strong id="labelModalMoveQty">0</strong></span>
                        <span class="text-primary fw-bold">선택합계: <strong id="labelModalSelectedQty">0</strong></span>
                    </div>
                </div>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0 align-middle">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width:40px;">
                                    <input type="checkbox" id="labelCheckAll" class="form-check-input" onchange="toggleAllLabels(this)">
                                </th>
                                <th>라벨ID</th>
                                <th class="text-end">수량</th>
                                <th class="text-center">유효기간</th>
                                <th class="text-center">D-Day</th>
                                <th class="text-center">발행일</th>
                            </tr>
                        </thead>
                        <tbody id="labelModalBody">
                        </tbody>
                    </table>
                </div>
                <div id="labelModalEmpty" class="text-center py-4 text-muted d-none">
                    <i class="bi bi-tag d-block mb-2" style="font-size:2rem; opacity:0.3;"></i>
                    <p class="mb-0">해당 품번/LOT에 발행된 라벨이 없습니다.<br>라벨 없이 이동합니다.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-warning fw-bold" id="labelSelectConfirmBtn" onclick="confirmLabelSelection()">
                    <i class="bi bi-check-circle me-1"></i>선택 완료
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 이동 내역 세부 모달 -->
<div class="modal fade" id="transferDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-arrow-left-right me-2"></i>이동 내역 상세
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-sm table-bordered mb-3">
                    <tbody>
                        <tr>
                            <th class="bg-light" style="width:25%;">수불번호</th>
                            <td id="detailTrxNo" class="fw-bold text-primary"></td>
                        </tr>
                        <tr>
                            <th class="bg-light">처리일시</th>
                            <td id="detailDate"></td>
                        </tr>
                        <tr>
                            <th class="bg-light">품번</th>
                            <td id="detailPartNo" class="fw-bold"></td>
                        </tr>
                        <tr>
                            <th class="bg-light">품명</th>
                            <td id="detailPartName"></td>
                        </tr>
                        <tr>
                            <th class="bg-light">수량</th>
                            <td id="detailQty" class="fw-bold"></td>
                        </tr>
                        <tr>
                            <th class="bg-light">LOT</th>
                            <td id="detailLot"></td>
                        </tr>
                        <tr>
                            <th class="bg-light">보내는 창고</th>
                            <td id="detailFromWh"></td>
                        </tr>
                        <tr>
                            <th class="bg-light">받는 창고</th>
                            <td id="detailToWh"></td>
                        </tr>
                        <tr>
                            <th class="bg-light">처리자</th>
                            <td id="detailActor"></td>
                        </tr>
                    </tbody>
                </table>

                <!-- 연결된 라벨 -->
                <div id="detailLabelsSection" class="d-none">
                    <h6 class="fw-bold mb-2">
                        <i class="bi bi-tags text-warning me-1"></i>투입된 라벨
                        <span class="badge bg-warning text-dark ms-1" id="detailLabelCount">0</span>
                    </h6>
                    <table class="table table-sm table-bordered mb-0 align-middle text-center">
                        <thead class="table-light">
                            <tr>
                                <th>라벨ID</th>
                                <th>수량</th>
                                <th>유효기간</th>
                                <th>투입시 잔여일</th>
                            </tr>
                        </thead>
                        <tbody id="detailLabelsBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentLotData = null;
    let qrScannedQty = null;

    // ============================================
    // QR 코드 스캔 처리
    // ============================================
    async function handleQRScan(qrData) {
        const qrInput = document.getElementById('qrScanInput');

        const parts = qrData.split('|');

        if (parts.length !== 3) {
            alert('올바른 QR 코드 형식이 아닙니다.\n형식: 품번|수량|LOT');
            qrInput.value = '';
            qrInput.focus();
            return;
        }

        const [partNo, qty, lotNo] = parts.map(p => p.trim());

        if (!partNo) {
            alert('품번 정보가 없습니다.');
            qrInput.value = '';
            qrInput.focus();
            return;
        }

        const fromLoc = document.getElementById('selFromLoc').value;
        const toLoc = document.getElementById('selToLoc').value;

        if (!fromLoc) {
            alert('먼저 "보내는 창고"를 선택해주세요.');
            document.getElementById('selFromLoc').focus();
            qrInput.value = '';
            return;
        }

        if (!toLoc) {
            alert('먼저 "받는 창고"를 선택해주세요.');
            document.getElementById('selToLoc').focus();
            qrInput.value = '';
            return;
        }

        document.getElementById('inputPart').value = partNo;
        qrScannedQty = parseInt(qty) || null;

        await loadAvailableLots();

        if (lotNo) {
            const lotMatched = await autoSelectLotByDate(lotNo);

            if (lotMatched) {
                qrInput.value = '';
                await addRow();
            } else {
                qrInput.value = '';
                document.getElementById('selLot').focus();
            }
        } else {
            qrInput.value = '';
            document.getElementById('selLot').focus();
        }
    }

    function autoSelectLotByDate(lotDateStr) {
        const lotSelect = document.getElementById('selLot');
        const options = lotSelect.options;

        for (let i = 1; i < options.length; i++) {
            const optionLotNo = options[i].dataset.lotNo;
            if (optionLotNo === lotDateStr) {
                lotSelect.selectedIndex = i;
                onLotSelect();

                if (qrScannedQty) {
                    document.getElementById('inputQty').value = qrScannedQty;
                }
                return true;
            }
        }

        alert(`QR 코드의 LOT(${lotDateStr})가 현재 창고에 없습니다.\n수동으로 LOT를 선택해주세요.`);
        return false;
    }

    async function loadAvailableLots() {
        const partNo = document.getElementById('inputPart').value.trim();
        const fromLoc = document.getElementById('selFromLoc').value;
        const lotSelect = document.getElementById('selLot');
        const lotInfo = document.getElementById('lotInfo');

        lotSelect.innerHTML = '<option value="">:: 품번/창고 선택 후 표시 ::</option>';
        lotSelect.disabled = true;
        lotInfo.textContent = '';
        currentLotData = null;

        if (!partNo || !fromLoc) return;

        try {
            const url = "{% url 'material:api_get_available_lots' %}?part_no=" + encodeURIComponent(partNo) + "&warehouse_code=" + encodeURIComponent(fromLoc);
            const res = await fetch(url, { method: 'GET' });
            const data = await res.json();

            if (!data.success) {
                lotInfo.textContent = data.error || 'LOT 정보를 가져올 수 없습니다.';
                lotInfo.className = 'text-danger small';
                return;
            }

            if (data.lots.length === 0) {
                lotSelect.innerHTML = '<option value="">:: 해당 창고에 재고 없음 ::</option>';
                lotInfo.textContent = '이동 가능한 재고가 없습니다.';
                lotInfo.className = 'text-danger small';
                return;
            }

            lotSelect.innerHTML = '<option value="">:: LOT 선택 ::</option>';
            data.lots.forEach((lot, index) => {
                const option = document.createElement('option');
                option.value = lot.stock_id;
                option.dataset.quantity = lot.quantity;
                option.dataset.lotNo = lot.lot_no || 'NO LOT';
                option.dataset.daysOld = lot.days_old;

                let displayText = lot.lot_no ? lot.lot_no : 'LOT 없음';
                displayText += ` (재고: ${lot.quantity.toLocaleString()} EA, ${lot.days_old}일 경과)`;

                if (index === 0 && lot.lot_no) {
                    displayText += ' ⚠️ FIFO 추천';
                }

                option.textContent = displayText;
                lotSelect.appendChild(option);
            });

            lotSelect.disabled = false;
            lotInfo.textContent = `총 ${data.lots.length}개 LOT 사용 가능`;
            lotInfo.className = 'text-success small';

        } catch (e) {
            lotInfo.textContent = 'LOT 정보 조회 실패';
            lotInfo.className = 'text-danger small';
            console.error(e);
        }
    }

    function onLotSelect() {
        const lotSelect = document.getElementById('selLot');
        const selectedOption = lotSelect.options[lotSelect.selectedIndex];
        const qtyInput = document.getElementById('inputQty');

        if (selectedOption.value) {
            currentLotData = {
                stock_id: selectedOption.value,
                lot_no: selectedOption.dataset.lotNo,
                max_qty: parseInt(selectedOption.dataset.quantity),
                days_old: parseInt(selectedOption.dataset.daysOld)
            };

            qtyInput.value = currentLotData.max_qty;
            qtyInput.max = currentLotData.max_qty;
        } else {
            currentLotData = null;
            qtyInput.value = '';
            qtyInput.removeAttribute('max');
        }
    }

    function selectPart(partNo) {
        document.getElementById('inputPart').value = partNo;
        document.getElementById('partSearchDropdown').style.display = 'none';
        loadAvailableLots();
    }

    // 제조현장 창고 코드 목록
    const PRODUCTION_CODES = {{ production_codes|safe }};

    // 라벨 선택 관련 변수
    let pendingRowData = null;
    let selectedLabelIds = [];

    // 행 추가 로직 (LOT 정보 포함)
    async function addRow() {
        const partNo = document.getElementById('inputPart').value.trim();
        const fromSel = document.getElementById('selFromLoc');
        const lotSel = document.getElementById('selLot');
        const toSel = document.getElementById('selToLoc');
        const qty = document.getElementById('inputQty').value;

        const fromVal = fromSel.value;
        const fromText = fromSel.options[fromSel.selectedIndex].text;
        const toVal = toSel.value;
        const toText = toSel.options[toSel.selectedIndex].text;

        if(!partNo) { alert('품번을 입력해주세요.'); return; }
        if(!fromVal) { alert('보내는 창고를 선택해주세요.'); return; }
        if(!lotSel.value) { alert('LOT를 선택해주세요.'); return; }
        if(!toVal) { alert('받는 창고를 선택해주세요.'); return; }
        if(fromVal === toVal) { alert('보내는 곳과 받는 곳이 같습니다.'); return; }
        if(!qty || parseInt(qty) <= 0) { alert('수량은 1 이상이어야 합니다.'); return; }

        if (currentLotData && parseInt(qty) > currentLotData.max_qty) {
            alert(`선택한 LOT의 재고(${currentLotData.max_qty} EA)를 초과할 수 없습니다.`);
            return;
        }

        const firstOption = lotSel.options[1];
        if (firstOption && lotSel.selectedIndex > 1) {
            const firstLotDays = parseInt(firstOption.dataset.daysOld);
            if (currentLotData.days_old < firstLotDays) {
                if (!confirm(`⚠️ FIFO 위반 경고!\n\n더 오래된 LOT가 있습니다.\n그래도 선택한 LOT로 이동하시겠습니까?`)) {
                    return;
                }
            }
        }

        try {
            const url = "{% url 'material:api_part_exists' %}?part_no=" + encodeURIComponent(partNo);
            const res = await fetch(url, { method: 'GET' });
            const data = await res.json();

            if (!data.exists) {
                alert('등록되지 않은 품번입니다: ' + partNo);
                document.getElementById('inputPart').focus();
                return;
            }
        } catch (e) {
            alert('품번 검증 중 오류가 발생했습니다.');
            return;
        }

        // 제조현장 이동 시 라벨 선택 모달
        if (PRODUCTION_CODES.includes(toVal)) {
            pendingRowData = {
                partNo, fromVal, fromText, toVal, toText,
                qty, stockId: currentLotData.stock_id,
                lotNo: currentLotData.lot_no
            };
            await showLabelSelectModal(partNo, currentLotData.lot_no, parseInt(qty));
            return;
        }

        finalizeAddRow(partNo, fromVal, fromText, toVal, toText, qty, currentLotData.stock_id, currentLotData.lot_no, '[]');
    }

    // 라벨 선택 모달 표시
    async function showLabelSelectModal(partNo, lotNo, moveQty) {
        const modalBody = document.getElementById('labelModalBody');
        const modalEmpty = document.getElementById('labelModalEmpty');
        const checkAll = document.getElementById('labelCheckAll');

        modalBody.innerHTML = '';
        checkAll.checked = false;
        selectedLabelIds = [];
        document.getElementById('labelModalSelectedQty').textContent = '0';
        document.getElementById('labelModalMoveQty').textContent = moveQty.toLocaleString();
        document.getElementById('labelModalPartInfo').textContent = `${partNo} / LOT: ${lotNo}`;

        try {
            const url = "{% url 'material:api_labels_for_lot' %}?part_no=" + encodeURIComponent(partNo) + "&lot_no=" + encodeURIComponent(lotNo);
            const res = await fetch(url);
            const data = await res.json();

            if (!data.success || data.count === 0) {
                modalBody.innerHTML = '';
                modalEmpty.classList.remove('d-none');
                document.getElementById('labelSelectConfirmBtn').textContent = '라벨 없이 진행';
            } else {
                modalEmpty.classList.add('d-none');
                document.getElementById('labelSelectConfirmBtn').innerHTML = '<i class="bi bi-check-circle me-1"></i>선택 완료';

                data.labels.forEach(lb => {
                    const dDayClass = lb.d_day === null ? '' :
                        lb.d_day < 0 ? 'd-day-expired' :
                        lb.d_day <= 30 ? 'd-day-imminent' :
                        lb.d_day <= 90 ? 'd-day-warning' : 'd-day-safe';
                    const dDayText = lb.d_day === null ? '-' :
                        lb.d_day < 0 ? `D+${Math.abs(lb.d_day)}` :
                        lb.d_day === 0 ? 'D-Day' : `D-${lb.d_day}`;

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <input type="checkbox" class="form-check-input label-check"
                                   value="${lb.id}" data-qty="${lb.quantity}"
                                   onchange="updateLabelSelection()">
                        </td>
                        <td><span class="text-muted" style="font-size:0.8rem; font-family:monospace;">${lb.label_id}</span></td>
                        <td class="text-end fw-bold">${lb.quantity}${lb.unit}</td>
                        <td class="text-center small">${lb.expiry_date || '-'}</td>
                        <td class="text-center"><span class="d-day-text ${dDayClass}">${dDayText}</span></td>
                        <td class="text-center small">${lb.printed_at || '-'}</td>
                    `;
                    modalBody.appendChild(tr);
                });
            }
        } catch (e) {
            console.error(e);
            modalBody.innerHTML = '';
            modalEmpty.classList.remove('d-none');
            document.getElementById('labelSelectConfirmBtn').textContent = '라벨 없이 진행';
        }

        const modal = new bootstrap.Modal(document.getElementById('labelSelectModal'));
        modal.show();
    }

    function toggleAllLabels(checkAll) {
        document.querySelectorAll('.label-check').forEach(cb => {
            cb.checked = checkAll.checked;
        });
        updateLabelSelection();
    }

    function updateLabelSelection() {
        let totalQty = 0;
        selectedLabelIds = [];
        document.querySelectorAll('.label-check:checked').forEach(cb => {
            selectedLabelIds.push(parseInt(cb.value));
            totalQty += parseFloat(cb.dataset.qty);
        });
        document.getElementById('labelModalSelectedQty').textContent = totalQty.toLocaleString();

        const allChecks = document.querySelectorAll('.label-check');
        const checkedCount = document.querySelectorAll('.label-check:checked').length;
        document.getElementById('labelCheckAll').checked = allChecks.length > 0 && checkedCount === allChecks.length;
    }

    function confirmLabelSelection() {
        const data = pendingRowData;
        if (!data) return;

        const labelIdsJson = JSON.stringify(selectedLabelIds);

        bootstrap.Modal.getInstance(document.getElementById('labelSelectModal')).hide();

        finalizeAddRow(data.partNo, data.fromVal, data.fromText, data.toVal, data.toText,
                       data.qty, data.stockId, data.lotNo, labelIdsJson);
        pendingRowData = null;
    }

    function finalizeAddRow(partNo, fromVal, fromText, toVal, toText, qty, stockId, lotNo, labelIdsJson) {
        const emptyRow = document.getElementById('emptyRow');
        if(emptyRow) emptyRow.remove();

        const tbody = document.getElementById('tableBody');
        const tr = document.createElement('tr');

        const lotDisplay = lotNo === 'NO LOT' ? '-' : lotNo;
        const labelCount = JSON.parse(labelIdsJson).length;
        const labelBadge = labelCount > 0 ? `<span class="badge bg-warning text-dark ms-1" title="선택된 라벨 ${labelCount}개"><i class="bi bi-tags"></i> ${labelCount}</span>` : '';

        tr.innerHTML = `
            <td class="fw-bold text-primary">
                ${partNo}
                <input type="hidden" name="part_no[]" value="${partNo}">
            </td>
            <td class="text-center">
                ${lotDisplay}
                <input type="hidden" name="stock_id[]" value="${stockId}">
            </td>
            <td>
                ${fromText}
                <input type="hidden" name="from_loc[]" value="${fromVal}">
            </td>
            <td class="text-muted"><i class="bi bi-arrow-right"></i></td>
            <td>
                ${toText}${labelBadge}
                <input type="hidden" name="to_loc[]" value="${toVal}">
                <input type="hidden" name="label_ids[]" value='${labelIdsJson}'>
            </td>
            <td class="fw-bold">
                ${parseInt(qty).toLocaleString()}
                <input type="hidden" name="move_qty[]" value="${qty}">
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">삭제</button>
            </td>
        `;

        tbody.appendChild(tr);
        updateCount();

        document.getElementById('inputPart').value = '';
        document.getElementById('selLot').innerHTML = '<option value="">:: 품번/창고 선택 후 표시 ::</option>';
        document.getElementById('selLot').disabled = true;
        document.getElementById('lotInfo').textContent = '';
        document.getElementById('inputQty').value = '';
        document.getElementById('inputQty').removeAttribute('max');
        currentLotData = null;
        qrScannedQty = null;

        document.getElementById('qrScanInput').focus();
    }

    function removeRow(btn) {
        btn.closest('tr').remove();
        const tbody = document.getElementById('tableBody');
        if(tbody.children.length === 0) {
            tbody.innerHTML = `<tr id="emptyRow"><td colspan="7" class="text-muted py-4">이동할 항목을 상단에서 추가해주세요.</td></tr>`;
        }
        updateCount();
    }

    function updateCount() {
        const count = document.querySelectorAll('input[name="part_no[]"]').length;
        document.getElementById('itemCount').innerText = count + "건";
    }

    // ============================================
    // 이동 내역 세부 조회
    // ============================================
    async function openTransferDetail(trxId) {
        try {
            const url = `/material/api/transfer-detail/${trxId}/`;
            const res = await fetch(url);
            const data = await res.json();

            if (!data.success) {
                alert(data.error || '조회 실패');
                return;
            }

            const t = data.trx;
            document.getElementById('detailTrxNo').textContent = t.transaction_no;
            document.getElementById('detailDate').textContent = t.date;
            document.getElementById('detailPartNo').textContent = t.part_no;
            document.getElementById('detailPartName').textContent = t.part_name;
            document.getElementById('detailQty').textContent = t.quantity.toLocaleString();
            document.getElementById('detailLot').textContent = t.lot_no;
            document.getElementById('detailFromWh').textContent = t.from_wh;
            document.getElementById('detailToWh').textContent = t.to_wh;
            document.getElementById('detailActor').textContent = t.actor;

            // 연결된 라벨
            const labelsSection = document.getElementById('detailLabelsSection');
            const labelsBody = document.getElementById('detailLabelsBody');
            labelsBody.innerHTML = '';

            if (data.label_count > 0) {
                labelsSection.classList.remove('d-none');
                document.getElementById('detailLabelCount').textContent = data.label_count;

                data.labels.forEach(lb => {
                    const dDayText = lb.used_d_day === null ? '-' :
                        lb.used_d_day < 0 ? `D+${Math.abs(lb.used_d_day)}` :
                        lb.used_d_day === 0 ? 'D-Day' : `D-${lb.used_d_day}`;
                    const dDayClass = lb.used_d_day === null ? '' :
                        lb.used_d_day < 0 ? 'text-danger fw-bold' :
                        lb.used_d_day <= 30 ? 'text-warning fw-bold' :
                        lb.used_d_day <= 90 ? 'text-primary fw-bold' : 'text-success fw-bold';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><span style="font-size:0.8rem; font-family:monospace;">${lb.label_id}</span></td>
                        <td class="fw-bold">${lb.quantity}${lb.unit}</td>
                        <td class="small">${lb.expiry_date}</td>
                        <td class="${dDayClass}">${dDayText}</td>
                    `;
                    labelsBody.appendChild(tr);
                });
            } else {
                labelsSection.classList.add('d-none');
            }

            const modal = new bootstrap.Modal(document.getElementById('transferDetailModal'));
            modal.show();
        } catch (e) {
            console.error(e);
            alert('이동 내역 조회 중 오류가 발생했습니다.');
        }
    }

    // 이벤트 리스너 등록
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('qrScanInput').addEventListener('keypress', function(e) {
            if(e.key === 'Enter') {
                e.preventDefault();
                const qrData = this.value.trim();
                if (qrData) {
                    handleQRScan(qrData);
                }
            }
        });

        document.getElementById('qrScanInput').focus();

        // 품번 자동완성
        let partSearchTimer = null;
        const partInput = document.getElementById('inputPart');
        const partDropdown = document.getElementById('partSearchDropdown');

        partInput.addEventListener('input', function() {
            clearTimeout(partSearchTimer);
            const q = this.value.trim();
            if (q.length < 2) { partDropdown.style.display = 'none'; return; }
            partSearchTimer = setTimeout(async () => {
                try {
                    const res = await fetch("{% url 'material:api_part_search' %}?q=" + encodeURIComponent(q));
                    const data = await res.json();
                    if (!data.results || data.results.length === 0) {
                        partDropdown.innerHTML = '<div class="px-3 py-2 text-muted small">검색 결과 없음</div>';
                        partDropdown.style.display = 'block';
                        return;
                    }
                    partDropdown.innerHTML = data.results.map(r => `
                        <div class="px-3 py-2 border-bottom" style="cursor:pointer;"
                             onmousedown="selectPart('${r.part_no}')">
                            <span class="fw-bold text-primary">${r.part_no}</span>
                            <span class="text-muted small ms-2">${r.part_name}</span>
                        </div>
                    `).join('');
                    partDropdown.style.display = 'block';
                } catch(e) { partDropdown.style.display = 'none'; }
            }, 300);
        });

        partInput.addEventListener('blur', function() {
            setTimeout(() => { partDropdown.style.display = 'none'; }, 200);
        });

        partInput.addEventListener('change', loadAvailableLots);
        document.getElementById('selFromLoc').addEventListener('change', loadAvailableLots);

        document.getElementById('selLot').addEventListener('change', onLotSelect);

        document.getElementById('inputQty').addEventListener('keypress', function(e) {
            if(e.key === 'Enter') {
                e.preventDefault();
                addRow();
            }
        });
    });
</script>
{% endblock %}
