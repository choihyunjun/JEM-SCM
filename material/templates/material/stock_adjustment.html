{% extends "material/material_base.html" %}

{% block title %}재고 조정(관리) - WMS{% endblock %}

{% block material_content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0"><i class="bi bi-sliders me-2"></i>재고 조정(관리)</h4>
        <a href="{% url 'material:closing_report' %}" class="btn btn-info btn-sm">
            <i class="bi bi-file-earmark-bar-graph me-1"></i>마감 재고 보고서
        </a>
    </div>

    <!-- 메시지 표시 -->
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{% if message.tags == 'error' %}danger{% elif message.tags == 'warning' %}warning{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
    {% endif %}

    <div class="row">
        <!-- 월 마감 관리 -->
        <div class="col-lg-5">
            <!-- 현재 마감 상태 -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-lock me-2"></i>재고 마감 현황
                </div>
                <div class="card-body">
                    {% if latest_closing %}
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-calendar-check me-2"></i>
                        <strong>현재 마감월:</strong> {{ latest_closing.closing_month|date:"Y년 m월" }}
                        <br>
                        <small class="text-muted">
                            마감일시: {{ latest_closing.closed_at|date:"Y-m-d H:i" }}
                            ({{ latest_closing.closed_by.username|default:"시스템" }})
                        </small>
                    </div>
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>{{ latest_closing.closing_month|date:"Y년 m월" }} 이전</strong> 날짜로 수불 입력 시 경고가 표시됩니다.
                    </div>
                    {% else %}
                    <div class="alert alert-secondary mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        아직 마감된 월이 없습니다.
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- 월 마감 처리 -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-calendar-plus me-2"></i>월 마감 처리
                </div>
                <div class="card-body">
                    <form method="post" id="closeMonthForm">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="close_month">

                        <div class="row g-3 mb-3">
                            <div class="col-6">
                                <label class="form-label">마감년도</label>
                                <select name="close_year" class="form-select" required>
                                    {% for y in "2023,2024,2025,2026,2027"|make_list %}
                                    <option value="{{ y }}" {% if y == next_closable.year|stringformat:"s" %}selected{% endif %}>
                                        {{ y }}년
                                    </option>
                                    {% endfor %}
                                    <option value="2024" {% if next_closable.year == 2024 %}selected{% endif %}>2024년</option>
                                    <option value="2025" {% if next_closable.year == 2025 %}selected{% endif %}>2025년</option>
                                    <option value="2026" {% if next_closable.year == 2026 %}selected{% endif %}>2026년</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">마감월</label>
                                <select name="close_month" class="form-select" required>
                                    {% for m in "1,2,3,4,5,6,7,8,9,10,11,12"|make_list %}
                                    <option value="{{ forloop.counter }}" {% if forloop.counter == next_closable.month %}selected{% endif %}>
                                        {{ forloop.counter }}월
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">비고</label>
                            <input type="text" name="remark" class="form-control" placeholder="마감 비고 (선택)">
                        </div>

                        <button type="button" class="btn btn-success w-100" onclick="confirmCloseMonth()">
                            <i class="bi bi-check-circle me-2"></i>월 마감 처리
                        </button>
                    </form>
                </div>
            </div>

            <!-- 마감 이력 -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <i class="bi bi-clock-history me-2"></i>마감 이력
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>마감월</th>
                                <th>처리일</th>
                                <th>처리자</th>
                                <th>상태</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for closing in closing_history %}
                            <tr>
                                <td><strong>{{ closing.closing_month|date:"Y-m" }}</strong></td>
                                <td>{{ closing.closed_at|date:"m/d H:i" }}</td>
                                <td>{{ closing.closed_by.username|default:"-" }}</td>
                                <td>
                                    {% if closing.is_active %}
                                    <span class="badge bg-success">활성</span>
                                    {% else %}
                                    <span class="badge bg-secondary">해제됨</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if closing.is_active %}
                                    <form method="post" style="display:inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="cancel_closing">
                                        <input type="hidden" name="closing_id" value="{{ closing.id }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger"
                                                onclick="return confirm('{{ closing.closing_month|date:"Y년 m월" }} 마감을 해제하시겠습니까?');">
                                            해제
                                        </button>
                                    </form>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-3">마감 이력이 없습니다.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 재고 조정 -->
        <div class="col-lg-7">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <i class="bi bi-pencil-square me-2"></i>재고 수량 조정
                </div>
                <div class="card-body">
                    <!-- 검색 폼 -->
                    <form method="get" class="row g-2 mb-3">
                        <div class="col-md-4">
                            <select name="warehouse" class="form-select form-select-sm">
                                <option value="">전체 창고</option>
                                {% for wh in warehouses %}
                                <option value="{{ wh.code }}" {% if warehouse_filter == wh.code %}selected{% endif %}>
                                    {{ wh.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-5">
                            <input type="text" name="q" class="form-control form-control-sm"
                                   placeholder="품번/품명 검색" value="{{ search_q }}">
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary btn-sm w-100">
                                <i class="bi bi-search me-1"></i>검색
                            </button>
                        </div>
                    </form>

                    <!-- 재고 목록 -->
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-sm table-hover table-striped mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>창고</th>
                                    <th>품번</th>
                                    <th>품명</th>
                                    <th>LOT</th>
                                    <th class="text-end">현재고</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stock in stocks %}
                                <tr>
                                    <td><small class="text-muted">{{ stock.warehouse.code }}</small></td>
                                    <td><strong>{{ stock.part.part_no }}</strong></td>
                                    <td>{{ stock.part.part_name|truncatechars:15 }}</td>
                                    <td>{{ stock.lot_no|date:"y.m.d"|default:"-" }}</td>
                                    <td class="text-end">
                                        <span class="badge bg-primary">{{ stock.quantity }}</span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-warning"
                                                data-bs-toggle="modal" data-bs-target="#adjustModal"
                                                onclick="openAdjustModal({{ stock.id }}, '{{ stock.part.part_no }}', '{{ stock.part.part_name|escapejs }}', {{ stock.quantity }}, '{{ stock.warehouse.name }}')">
                                            조정
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        {% if search_q or warehouse_filter %}
                                        검색 결과가 없습니다.
                                        {% else %}
                                        재고 데이터가 없습니다.
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if stocks %}
                    <div class="text-muted small mt-2">
                        <i class="bi bi-info-circle me-1"></i>
                        최대 100건까지 표시됩니다. 필요시 검색 조건을 입력하세요.
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- 엑셀 일괄 조정 -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <i class="bi bi-file-earmark-excel me-2"></i>엑셀 일괄 조정
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="alert alert-secondary py-2 mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>사용방법:</strong> 양식 다운로드 → 수량 수정 → 업로드
                                <br>
                                <small class="text-muted">
                                    - 기존 재고: 해당 창고+품번+LOT의 재고를 덮어씁니다<br>
                                    - 신규 재고: 없는 조합은 새로 추가됩니다
                                </small>
                            </div>

                            <!-- 양식 다운로드 버튼 -->
                            <div class="btn-group mb-3" role="group">
                                <a href="{% url 'material:stock_adjustment_template' %}" class="btn btn-outline-success">
                                    <i class="bi bi-download me-1"></i>빈 양식 다운로드
                                </a>
                                <a href="{% url 'material:stock_adjustment_template' %}?include_data=true" class="btn btn-success">
                                    <i class="bi bi-download me-1"></i>현재 재고 포함 다운로드
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- 업로드 폼 -->
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="upload_excel">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-8">
                                <label class="form-label">엑셀 파일 선택</label>
                                <input type="file" name="excel_file" class="form-control"
                                       accept=".xlsx,.xls" required>
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-info w-100" onclick="return confirm('엑셀 파일을 업로드하여 재고를 일괄 조정하시겠습니까?\\n\\n기존 재고가 있으면 덮어쓰고, 없으면 새로 추가됩니다.\\n(품목마스터에 없는 품번은 실패 처리됩니다)');">
                                    <i class="bi bi-upload me-1"></i>업로드 및 적용
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- 안내 문구 추가 -->
                    <div class="alert alert-warning mt-3 mb-0 py-2">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>주의:</strong> 품목마스터에 등록되지 않은 품번은 자동 등록되지 않고 실패 처리됩니다.
                        <a href="{% url 'part_upload' %}" class="alert-link">품목마스터 등록</a> 후 재고 업로드를 진행하세요.
                    </div>
                </div>
            </div>

            <!-- 업로드 실패 로그 -->
            {% if recent_error_logs %}
            <div class="card mt-4">
                <div class="card-header bg-danger text-white">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>최근 업로드 실패 로그 (품목마스터 미등록)
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                        <table class="table table-sm table-striped mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>품번</th>
                                    <th>실패 사유</th>
                                    <th>원본 데이터</th>
                                    <th>업로드 일시</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in recent_error_logs %}
                                <tr>
                                    <td class="fw-bold text-danger">{{ log.part_no }}</td>
                                    <td>{{ log.error_reason }}</td>
                                    <td class="small text-muted">{{ log.row_data|truncatechars:40 }}</td>
                                    <td class="small">{{ log.uploaded_at|date:"Y-m-d H:i" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 재고 조정 모달 -->
<div class="modal fade" id="adjustModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>재고 수량 조정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="adjust_stock">
                <input type="hidden" name="stock_id" id="adjustStockId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">품번</label>
                        <input type="text" class="form-control" id="adjustPartNo" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">품명</label>
                        <input type="text" class="form-control" id="adjustPartName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">창고</label>
                        <input type="text" class="form-control" id="adjustWarehouse" readonly>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <label class="form-label">현재 수량</label>
                            <input type="number" class="form-control" id="adjustOldQty" readonly>
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-bold text-warning">조정 수량</label>
                            <input type="number" name="new_qty" id="adjustNewQty" class="form-control" required min="0">
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">조정 사유</label>
                        <input type="text" name="remark" class="form-control" placeholder="실사 결과, 재고 오차 등">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check me-1"></i>조정 적용
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function confirmCloseMonth() {
    const year = document.querySelector('select[name="close_year"]').value;
    const month = document.querySelector('select[name="close_month"]').value;

    if (confirm(`${year}년 ${month}월을 마감 처리하시겠습니까?\n\n마감 후에는 해당 월 이전 날짜로 수불 입력 시 경고가 표시됩니다.`)) {
        document.getElementById('closeMonthForm').submit();
    }
}

function openAdjustModal(stockId, partNo, partName, currentQty, warehouseName) {
    document.getElementById('adjustStockId').value = stockId;
    document.getElementById('adjustPartNo').value = partNo;
    document.getElementById('adjustPartName').value = partName;
    document.getElementById('adjustWarehouse').value = warehouseName;
    document.getElementById('adjustOldQty').value = currentQty;
    document.getElementById('adjustNewQty').value = currentQty;
    document.getElementById('adjustNewQty').focus();
}
</script>
{% endblock %}
