{% extends 'material/material_base.html' %}
{% load humanize %}

{% block title %}원재료 창고 레이아웃{% endblock %}

{% block material_content %}
<style>
    .main-container {
        display: flex;
        gap: 24px;
        min-height: calc(100vh - 200px);
    }
    .warehouse-area {
        flex: 1;
        background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 16px;
        padding: 32px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        overflow-x: auto;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
        border: 1px solid #e2e8f0;
    }
    .warehouse-inner {
        display: flex;
        gap: 36px;
        align-items: flex-start;
    }
    .wall-box {
        background: #fff;
        border-radius: 14px;
        padding: 24px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .wall-title {
        text-align: center;
        color: #fff;
        font-weight: 600;
        font-size: 1.1rem;
        padding: 11px 32px;
        border-radius: 8px;
        margin-bottom: 20px;
        letter-spacing: 0.5px;
    }
    .wall-title.wall-a {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }
    .wall-title.wall-b {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }
    .wall-title.wall-2f {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
    }
    /* 2공장 전용 스타일 */
    .pallet-grid {
        display: grid;
        grid-template-columns: repeat(3, 200px);
        gap: 15px;
    }
    .floor-row {
        display: flex;
        gap: 20px;
    }
    .floor-col {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .floor-labels {
        display: flex;
        gap: 20px;
        margin-top: 15px;
    }
    .floor-label {
        color: #64748b;
        font-size: 0.9rem;
        font-weight: 600;
        padding: 8px 20px;
        width: 200px;
        text-align: center;
        background: #f1f5f9;
        border-radius: 6px;
        letter-spacing: 0.3px;
    }
    .cells-stack {
        display: flex;
        flex-direction: column-reverse;
        gap: 12px;
        min-height: 50px;
    }
    .rack-cell {
        width: 200px;
        height: 112px;
        border-radius: 12px;
        padding: 14px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        justify-content: center;
        border: 1px solid transparent;
        position: relative;
    }
    .rack-cell:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .rack-cell.empty {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
    }
    .rack-cell.empty:hover {
        border-color: #94a3b8;
        background: #f1f5f9;
    }
    .rack-cell.safe {
        background: #22c55e;
        box-shadow: 0 2px 8px rgba(34, 197, 94, 0.25);
    }
    .rack-cell.safe .rack-position,
    .rack-cell.safe .rack-part-no,
    .rack-cell.safe .rack-part-name,
    .rack-cell.safe .rack-stock {
        color: #fff;
    }
    .rack-cell.safe .rack-position { opacity: 0.85; }
    .rack-cell.safe .rack-part-name { opacity: 0.9; }
    .rack-cell.warning {
        background: #f59e0b;
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.25);
    }
    .rack-cell.warning .rack-position,
    .rack-cell.warning .rack-part-no,
    .rack-cell.warning .rack-part-name,
    .rack-cell.warning .rack-stock {
        color: #fff;
    }
    .rack-cell.warning .rack-position { opacity: 0.85; }
    .rack-cell.warning .rack-part-name { opacity: 0.9; }
    .rack-cell.danger {
        background: #ef4444;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
    }
    .rack-cell.danger .rack-position,
    .rack-cell.danger .rack-part-no,
    .rack-cell.danger .rack-part-name,
    .rack-cell.danger .rack-stock {
        color: #fff;
    }
    .rack-cell.danger .rack-position { opacity: 0.85; }
    .rack-cell.danger .rack-part-name { opacity: 0.9; }
    .rack-position {
        font-size: 0.75rem;
        color: #94a3b8;
        margin-bottom: 5px;
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    .rack-part-no {
        font-weight: 700;
        font-size: 1.1rem;
        color: #1e293b;
        line-height: 1.2;
        font-family: 'SF Mono', 'Consolas', monospace;
    }
    .rack-part-name {
        font-size: 0.78rem;
        color: #64748b;
        margin-top: 4px;
        line-height: 1.3;
        word-break: keep-all;
    }
    .rack-stock {
        font-weight: 700;
        font-size: 1.05rem;
        margin-top: 6px;
    }
    .empty-dash {
        color: #cbd5e1;
        font-size: 1.4rem;
    }
    .aisle-area {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0 16px;
        align-self: stretch;
    }
    .aisle-text {
        color: #64748b;
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 12px;
        margin-top: 48px;
        background: #f1f5f9;
        padding: 6px 16px;
        border-radius: 20px;
        letter-spacing: 0.3px;
    }
    .aisle-line {
        flex: 1;
        width: 2px;
        background: linear-gradient(to bottom, #cbd5e1 50%, transparent 50%);
        background-size: 2px 12px;
    }
    /* 사이드바 */
    .sidebar {
        width: 280px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        flex-shrink: 0;
    }
    .sidebar-card {
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 2px 8px rgba(0,0,0,0.04);
        overflow: hidden;
        border: 1px solid #e2e8f0;
    }
    .sidebar-header {
        background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
        padding: 14px 18px;
        font-weight: 600;
        font-size: 0.9rem;
        border-bottom: 1px solid #e2e8f0;
        color: #475569;
    }
    .sidebar-body {
        padding: 16px 18px;
    }
    .legend-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 0.85rem;
        color: #475569;
    }
    .legend-dot {
        width: 32px;
        height: 24px;
        border-radius: 5px;
        flex-shrink: 0;
    }
    .legend-dot.safe {
        background: #22c55e;
    }
    .legend-dot.warning {
        background: #f59e0b;
    }
    .legend-dot.danger {
        background: #ef4444;
    }
    .legend-dot.empty {
        background: #f1f5f9;
        border: 1px solid #cbd5e1;
    }
    .quick-links {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .quick-links .btn {
        text-align: left;
        padding: 11px 14px;
        font-size: 0.85rem;
        border-radius: 10px;
        font-weight: 500;
        transition: all 0.2s;
    }
    .quick-links .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
        box-shadow: 0 2px 6px rgba(16, 185, 129, 0.25);
    }
    .quick-links .btn-success:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.35);
    }
    .quick-links .btn-outline-secondary {
        border-color: #e2e8f0;
        color: #475569;
    }
    .quick-links .btn-outline-secondary:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
    }
    .section-tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .section-tabs .btn {
        flex: 1;
        min-width: 80px;
        border-radius: 8px;
        font-weight: 500;
        padding: 8px 16px;
    }
    .section-tabs .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border: none;
        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
    }
    .section-tabs .btn-outline-primary {
        border-color: #e2e8f0;
        color: #475569;
    }
    .section-tabs .btn-outline-primary:hover {
        background: #f8fafc;
        border-color: #3b82f6;
        color: #3b82f6;
    }
    .no-rack-msg {
        text-align: center;
        padding: 60px 30px;
        color: #64748b;
    }
    .no-rack-msg i {
        font-size: 3rem;
        margin-bottom: 15px;
        display: block;
        color: #cbd5e1;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold text-secondary m-0">
        <i class="bi bi-grid-3x3-gap me-2"></i>원재료 창고 레이아웃
    </h4>
    <div class="section-tabs">
        {% for code, name in sections %}
        <a href="?section={{ code }}" class="btn btn-sm {% if section == code %}btn-primary{% else %}btn-outline-primary{% endif %}">
            {{ name }}
        </a>
        {% endfor %}
    </div>
</div>

<div class="main-container">
    <!-- 창고 영역 -->
    <div class="warehouse-area">
        {% if section == '2F' %}
        <!-- 2공장 레이아웃: 2행 × 3열 파렛트 그리드 -->
        {% if wall_a.1 or wall_a.2 %}
        <div class="wall-box">
            <div class="wall-title wall-2f">2공장</div>
            <div class="pallet-grid">
                {% for cell in wall_a.1 %}
                <div class="rack-cell {{ cell.stock_status }}" title="{{ cell.rack.position_code }}">
                    <div class="rack-position">{{ cell.rack.position_code }}</div>
                    {% if cell.rack.part %}
                    <div class="rack-part-no">{{ cell.rack.part.part_no }}</div>
                    <div class="rack-part-name">{{ cell.rack.part.part_name }}</div>
                    <div class="rack-stock">{{ cell.stock_qty|intcomma }}kg</div>
                    {% else %}
                    <span class="empty-dash">—</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <div class="pallet-grid" style="margin-top: 15px;">
                {% for cell in wall_a.2 %}
                <div class="rack-cell {{ cell.stock_status }}" title="{{ cell.rack.position_code }}">
                    <div class="rack-position">{{ cell.rack.position_code }}</div>
                    {% if cell.rack.part %}
                    <div class="rack-part-no">{{ cell.rack.part.part_no }}</div>
                    <div class="rack-part-name">{{ cell.rack.part.part_name }}</div>
                    <div class="rack-stock">{{ cell.stock_qty|intcomma }}kg</div>
                    {% else %}
                    <span class="empty-dash">—</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="no-rack-msg">
            <i class="bi bi-inbox"></i>
            <p>등록된 파렛트가 없습니다</p>
            <a href="{% url 'material:raw_material_rack_manage' %}?section={{ section }}" class="btn btn-outline-primary btn-sm mt-2">
                <i class="bi bi-plus-lg me-1"></i>파렛트 등록
            </a>
        </div>
        {% endif %}
        {% else %}
        <!-- 3공장 레이아웃: A열/B열 + 통로 -->
        {% if wall_a.1 or wall_a.2 or wall_b.1 or wall_b.2 %}
        <div class="warehouse-inner">
            <!-- A열 -->
            <div class="wall-box">
                <div class="wall-title wall-a">A열</div>
                <div class="floor-row">
                    <div class="floor-col">
                        <div class="cells-stack">
                            {% for cell in wall_a.2 %}
                            <div class="rack-cell {{ cell.stock_status }}" title="{{ cell.rack.position_code }}">
                                <div class="rack-position">{{ cell.rack.position_code }}</div>
                                {% if cell.rack.part %}
                                <div class="rack-part-no">{{ cell.rack.part.part_no }}</div>
                                <div class="rack-part-name">{{ cell.rack.part.part_name }}</div>
                                <div class="rack-stock">{{ cell.stock_qty|intcomma }}kg</div>
                                {% else %}
                                <span class="empty-dash">—</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="floor-col">
                        <div class="cells-stack">
                            {% for cell in wall_a.1 %}
                            <div class="rack-cell {{ cell.stock_status }}" title="{{ cell.rack.position_code }}">
                                <div class="rack-position">{{ cell.rack.position_code }}</div>
                                {% if cell.rack.part %}
                                <div class="rack-part-no">{{ cell.rack.part.part_no }}</div>
                                <div class="rack-part-name">{{ cell.rack.part.part_name }}</div>
                                <div class="rack-stock">{{ cell.stock_qty|intcomma }}kg</div>
                                {% else %}
                                <span class="empty-dash">—</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="floor-labels">
                    <div class="floor-label">2층</div>
                    <div class="floor-label">1층</div>
                </div>
            </div>

            {% if wall_b.1 or wall_b.2 %}
            <!-- 통로 -->
            <div class="aisle-area">
                <div class="aisle-text">통로</div>
                <div class="aisle-line"></div>
            </div>

            <!-- B열 -->
            <div class="wall-box">
                <div class="wall-title wall-b">B열</div>
                <div class="floor-row">
                    <div class="floor-col">
                        <div class="cells-stack">
                            {% for cell in wall_b.1 %}
                            <div class="rack-cell {{ cell.stock_status }}" title="{{ cell.rack.position_code }}">
                                <div class="rack-position">{{ cell.rack.position_code }}</div>
                                {% if cell.rack.part %}
                                <div class="rack-part-no">{{ cell.rack.part.part_no }}</div>
                                <div class="rack-part-name">{{ cell.rack.part.part_name }}</div>
                                <div class="rack-stock">{{ cell.stock_qty|intcomma }}kg</div>
                                {% else %}
                                <span class="empty-dash">—</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="floor-col">
                        <div class="cells-stack">
                            {% for cell in wall_b.2 %}
                            <div class="rack-cell {{ cell.stock_status }}" title="{{ cell.rack.position_code }}">
                                <div class="rack-position">{{ cell.rack.position_code }}</div>
                                {% if cell.rack.part %}
                                <div class="rack-part-no">{{ cell.rack.part.part_no }}</div>
                                <div class="rack-part-name">{{ cell.rack.part.part_name }}</div>
                                <div class="rack-stock">{{ cell.stock_qty|intcomma }}kg</div>
                                {% else %}
                                <span class="empty-dash">—</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="floor-labels">
                    <div class="floor-label">1층</div>
                    <div class="floor-label">2층</div>
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="no-rack-msg">
            <i class="bi bi-inbox"></i>
            <p>등록된 랙이 없습니다</p>
            <a href="{% url 'material:raw_material_rack_manage' %}?section={{ section }}" class="btn btn-outline-primary btn-sm mt-2">
                <i class="bi bi-plus-lg me-1"></i>랙 등록
            </a>
        </div>
        {% endif %}
        {% endif %}
    </div>

    <!-- 사이드바 -->
    <div class="sidebar">
        <!-- 범례 -->
        <div class="sidebar-card">
            <div class="sidebar-header">
                <i class="bi bi-palette me-2"></i>재고 상태
            </div>
            <div class="sidebar-body">
                <div class="legend-list">
                    <div class="legend-item">
                        <div class="legend-dot safe"></div>
                        <span>충분 - 경고재고 초과</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot warning"></div>
                        <span>경고 - 안전재고~경고재고</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot danger"></div>
                        <span>위험 - 안전재고 미만</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot empty"></div>
                        <span>미배치 - 품목 없음</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 빠른 메뉴 -->
        <div class="sidebar-card">
            <div class="sidebar-header">
                <i class="bi bi-lightning me-2"></i>빠른 메뉴
            </div>
            <div class="sidebar-body">
                <div class="quick-links">
                    <a href="{% url 'material:raw_material_incoming' %}" class="btn btn-success">
                        <i class="bi bi-box-arrow-in-down me-2"></i>원재료 입고
                    </a>
                    <a href="{% url 'material:raw_material_rack_manage' %}?section={{ section }}" class="btn btn-outline-secondary">
                        <i class="bi bi-gear me-2"></i>랙 위치 관리
                    </a>
                    <a href="{% url 'material:raw_material_setting' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-sliders me-2"></i>품목 설정
                    </a>
                </div>
            </div>
        </div>

        <!-- 자동 새로고침 안내 -->
        <div class="sidebar-card">
            <div class="sidebar-body text-center text-muted" style="font-size: 0.8rem;">
                <i class="bi bi-arrow-clockwise me-1"></i>30초마다 자동 새로고침
            </div>
        </div>
    </div>
</div>

<script>
setTimeout(function() { location.reload(); }, 30000);
</script>
{% endblock %}
