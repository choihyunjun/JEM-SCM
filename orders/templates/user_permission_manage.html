{% extends "base.html" %}
{% load auth_extras %}

{% block title %}ì‚¬ìš©ì ê¶Œí•œ ê´€ë¦¬{% endblock %}

{% block content %}
<div class="container-fluid p-0" style="max-width: 1920px;">

<h2 class="mb-4">
    <i class="bi bi-shield-lock me-2"></i>ì‚¬ìš©ì ê¶Œí•œ ê´€ë¦¬
</h2>

<!-- ë©”ì‹œì§€ -->
{% if messages %}
{% for message in messages %}
<div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}

<div class="row">
    <!-- ì™¼ìª½: ì‚¬ìš©ì ëª©ë¡ -->
    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">
                <i class="bi bi-people me-2"></i>ì‚¬ìš©ì ëª©ë¡
            </div>
            <div class="card-body p-0">
                <!-- ê²€ìƒ‰/í•„í„° -->
                <div class="p-3 border-bottom bg-light">
                    <form method="get" class="row g-2">
                        <div class="col-12">
                            <input type="text" name="q" class="form-control form-control-sm"
                                   placeholder="ì‚¬ìš©ìëª… ê²€ìƒ‰..." value="{{ search_q }}">
                        </div>
                        <div class="col-8">
                            <select name="role" class="form-select form-select-sm">
                                <option value="">ì „ì²´ ì—­í• </option>
                                {% for value, label in role_choices %}
                                <option value="{{ value }}" {% if role_filter == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-4">
                            <button type="submit" class="btn btn-sm btn-primary w-100">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- ì‚¬ìš©ì ë¦¬ìŠ¤íŠ¸ -->
                <div class="list-group list-group-flush" style="max-height: 500px; overflow-y: auto;">
                    {% for u in users %}
                    <a href="?user_id={{ u.id }}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if search_q %}&q={{ search_q }}{% endif %}"
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center
                              {% if selected_user and selected_user.id == u.id %}active{% endif %}">
                        <div>
                            <strong>{{ u.username }}</strong>
                            {% if u.profile.display_name %}
                            <small class="text-muted ms-1">({{ u.profile.display_name }})</small>
                            {% endif %}
                            <br>
                            <small>
                                {% if u.profile.role == 'ADMIN' %}
                                <span class="badge bg-danger">ê´€ë¦¬ì</span>
                                {% elif u.profile.role == 'STAFF' %}
                                <span class="badge bg-primary">ì§ì›</span>
                                {% else %}
                                <span class="badge bg-secondary">í˜‘ë ¥ì—…ì²´</span>
                                {% endif %}
                            </small>
                        </div>
                        <i class="bi bi-chevron-right"></i>
                    </a>
                    {% empty %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ê¶Œí•œ ì„¤ì • -->
    <div class="col-lg-8">
        {% if selected_user and selected_profile %}
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-person-gear me-2"></i>
                    <strong>{{ selected_user.username }}</strong> ê¶Œí•œ ì„¤ì •
                    {% if selected_profile.display_name %}
                    <small>({{ selected_profile.display_name }})</small>
                    {% endif %}
                </span>
                <div>
                    <form method="post" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="user_id" value="{{ selected_user.id }}">
                        <button type="submit" name="action" value="grant_all" class="btn btn-sm btn-success me-1"
                                onclick="return confirm('ì „ì²´ ê¶Œí•œì„ ë¶€ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                            <i class="bi bi-check-all me-1"></i>ì „ì²´ ë¶€ì—¬
                        </button>
                        <button type="submit" name="action" value="revoke_all" class="btn btn-sm btn-outline-light"
                                onclick="return confirm('ëª¨ë“  ê¶Œí•œì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                            <i class="bi bi-x-lg me-1"></i>ì „ì²´ í•´ì œ
                        </button>
                    </form>
                </div>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="save_permissions">
                    <input type="hidden" name="user_id" value="{{ selected_user.id }}">

                    <!-- ê¸°ë³¸ ì •ë³´ -->
                    <div class="mb-4 p-3 bg-light rounded">
                        <h6 class="fw-bold mb-3"><i class="bi bi-person-vcard me-1"></i>ê¸°ë³¸ ì •ë³´</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">ê¸°ë³¸ ì—­í• </label>
                                <select name="role" class="form-select form-select-sm">
                                    {% for value, label in role_choices %}
                                    <option value="{{ value }}" {% if selected_profile.role == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">í‘œì‹œ ì´ë¦„</label>
                                <input type="text" name="display_name" class="form-control form-control-sm"
                                       value="{{ selected_profile.display_name|default:'' }}" placeholder="ì˜ˆ: í™ê¸¸ë™">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">ë¶€ì„œ</label>
                                <input type="text" name="department" class="form-control form-control-sm"
                                       value="{{ selected_profile.department|default:'' }}" placeholder="ì˜ˆ: í’ˆì§ˆê´€ë¦¬íŒ€">
                            </div>
                        </div>
                        <div class="form-text mt-2">
                            <i class="bi bi-info-circle me-1"></i>
                            ì—­í• ì— ë”°ë¼ ê¸°ë³¸ ë©”ë‰´ ì ‘ê·¼ì´ ê²°ì •ë˜ë©°, í‘œì‹œì´ë¦„/ë¶€ì„œëŠ” ê²°ì¬ì„  ê²€ìƒ‰ì— í‘œì‹œë©ë‹ˆë‹¤.
                        </div>
                    </div>

                    <!-- ê¶Œí•œ ì²´í¬ë°•ìŠ¤ (View/Edit ë¶„ë¦¬) -->
                    <div class="row">
                        {% for category, fields in permission_fields.items %}
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header py-2
                                    {% if 'SCM' in category %}bg-success{% elif 'WMS' in category %}bg-info{% else %}bg-warning{% endif %} text-white">
                                    <strong>
                                        {% if 'SCM' in category %}
                                        <i class="bi bi-cart me-1"></i>
                                        {% elif 'WMS' in category %}
                                        <i class="bi bi-box-seam me-1"></i>
                                        {% else %}
                                        <i class="bi bi-clipboard-check me-1"></i>
                                        {% endif %}
                                        {{ category }}
                                    </strong>
                                </div>
                                <div class="card-body p-2">
                                    <table class="table table-sm table-borderless mb-0">
                                        {% for field_name, label in fields %}
                                        <tr class="{% if '_edit' in field_name %}border-bottom{% endif %}">
                                            <td style="width: 30px;">
                                                <input type="checkbox" name="{{ field_name }}" id="{{ field_name }}"
                                                       class="form-check-input"
                                                       {% if selected_profile|getattribute:field_name %}checked{% endif %}>
                                            </td>
                                            <td>
                                                <label class="form-check-label {% if '_edit' in field_name %}text-primary fw-bold{% else %}text-secondary{% endif %}"
                                                       for="{{ field_name }}" style="cursor: pointer;">
                                                    {{ label }}
                                                </label>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="alert alert-info small mt-3">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>ğŸ“‹ ì¡°íšŒ</strong> ê¶Œí•œì€ í•´ë‹¹ ë©”ë‰´ë¥¼ ë³¼ ìˆ˜ ìˆëŠ” ê¶Œí•œì´ê³ ,
                        <strong class="text-primary">âœï¸ ìˆ˜ì •</strong> ê¶Œí•œì€ ë“±ë¡/ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì…ë‹ˆë‹¤.
                    </div>

                    <!-- ì €ì¥ ë²„íŠ¼ -->
                    <div class="text-end mt-3">
                        <a href="{% url 'user_permission_manage' %}" class="btn btn-secondary me-2">
                            <i class="bi bi-arrow-left me-1"></i>ëª©ë¡ìœ¼ë¡œ
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-lg me-1"></i>ê¶Œí•œ ì €ì¥
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% else %}
        <!-- ë¯¸ì„ íƒ ìƒíƒœ -->
        <div class="card shadow-sm">
            <div class="card-body text-center py-5">
                <i class="bi bi-arrow-left-circle text-muted" style="font-size: 4rem;"></i>
                <h5 class="mt-3 text-muted">ì™¼ìª½ì—ì„œ ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”</h5>
                <p class="text-muted">ì„ íƒí•œ ì‚¬ìš©ìì˜ ê¶Œí•œì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

</div>
{% endblock %}
