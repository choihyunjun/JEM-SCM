{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="mb-4 d-flex align-items-center flex-wrap gap-3">
    <div>
        <span class="badge bg-success me-2">협력사 전용</span>
        <span class="fw-bold text-secondary">납품서 등록 및 라벨 발행</span>
    </div>

    {% if user.is_superuser or user.profile.role == 'STAFF' %}
    <div class="d-flex align-items-center gap-2 ms-2">
        <form method="get" class="d-flex align-items-center gap-2">
            <select name="vendor_id" class="form-select form-select-sm shadow-sm" onchange="this.form.submit()" style="width: 180px; border-color: #198754; background-color: #f8fff9;">
                <option value="">== 업체 전체 선택 ==</option>
                {% for v in vendor_list %}
                    <option value="{{ v.id }}" {% if selected_vendor_id == v.id|stringformat:"s" %}selected{% endif %}>
                        {{ v.name }}
                    </option>
                {% endfor %}
            </select>

            <div class="input-group input-group-sm" style="width: 220px;">
                <input type="text" name="q" value="{{ q|default:'' }}" class="form-control border-primary shadow-sm" placeholder="품번 또는 품명 검색">
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-search"></i>
                </button>
            </div>
            
            <input type="hidden" name="status" value="{{ status_filter|default:'' }}">
        </form>

        <form method="get" class="d-flex align-items-center">
            <input type="hidden" name="vendor_id" value="{{ selected_vendor_id|default:'' }}">
            <input type="hidden" name="q" value="{{ q|default:'' }}">
            <select name="status" class="form-select form-select-sm shadow-sm" onchange="this.form.submit()" style="width: 130px; border-color: #0d6efd;">
                <option value="">== 전체 상태 ==</option>
                <option value="registered" {% if status_filter == 'registered' %}selected{% endif %}>등록완료</option>
                <option value="received" {% if status_filter == 'received' %}selected{% endif %}>입고완료</option>
            </select>
        </form>
    </div>
    {% endif %}
</div>

<div class="card border-dark shadow-sm mb-4">
    <div class="card-header bg-dark text-white fw-bold">
        <i class="bi bi-files"></i> 최근 생성된 납품서
    </div>
    <div class="card-body p-0">

        <ul class="nav nav-tabs mb-3" id="orderTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active fw-bold" id="active-tab" data-bs-toggle="tab" data-bs-target="#active-pane" type="button" role="tab">
            <i class="bi bi-list-check me-1"></i> 납품/발행 현황
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold text-danger" id="return-tab" data-bs-toggle="tab" data-bs-target="#return-pane" type="button" role="tab">
            <i class="bi bi-exclamation-triangle-fill me-1"></i> 부적합 / 반출 내역
            {% if return_pending_count %}
                <span class="badge bg-danger rounded-pill ms-1">{{ return_pending_count }}</span>
            {% endif %}
        </button>
    </li>
</ul>


        <div class="tab-content" id="orderTabsContent">

            <div class="tab-pane fade show active" id="active-pane" role="tabpanel">
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover mb-0 text-center align-middle">
                        <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
                            <tr>
                                <th style="width: 25%;">납품서 번호</th>
                                <th style="width: 20%;">등록 일시</th>
                                <th style="width: 15%;">포함 품목 수</th>
                                <th style="width: 15%;">상태</th>
                                <th style="width: 25%;">관리</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr>
                                <td class="fw-bold text-primary">{{ order.order_no }}</td>
                                <td>{{ order.created_at|date:"Y-m-d H:i" }}</td>
                                <td>{{ order.items.count }} 품목</td>
                                <td>
                                    {% if order.status == 'PENDING' %}
                                        <span class="badge bg-secondary">배송중</span>
                                    {% elif order.status == 'RECEIVED' %}
                                        <span class="badge bg-warning text-dark">검사대기</span>
                                    {% elif order.status == 'APPROVED' %}
                                        <span class="badge bg-success">입고완료</span>
                                    {% elif order.status == 'REJECTED' %}
                                        <span class="badge bg-danger">반려(전수불량)</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-1 justify-content-start">
                                        <button class="btn btn-sm btn-outline-dark" onclick="openPrintPopup('{{ order.id }}')">
                                            <i class="bi bi-printer"></i> 라벨
                                        </button>
                                        <a href="{% url 'delivery_note_print' order.id %}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-file-text"></i> 납품서
                                        </a>
                                        {% if order.status == 'PENDING' %}
                                        <form action="{% url 'delete_delivery_order' order.id %}" method="post" class="m-0">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('정말 삭제하시겠습니까?\n(발행된 라벨 이력도 함께 삭제됩니다)')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5" class="text-center py-4 text-muted">내역이 없습니다.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="return-pane" role="tabpanel">
                <div class="alert alert-danger d-flex align-items-center mb-3">
                    <i class="bi bi-exclamation-circle-fill fs-4 me-3"></i>
                    <div>
                        <strong>수입검사 불합격(부적합) 내역입니다.</strong><br>
                        반출증을 수령하신 후 <strong>[반출 확인]</strong> 버튼을 눌러주세요, 해당 수량만큼 <u>납품 가능 수량이 복구</u>되어 납품서를 추가 발행할 수 있습니다.
                    </div>
                </div>

                <div class="card shadow-sm border-0 border-start border-danger border-4">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>납품서 번호</th>
                                        <th>판정 일자</th>
                                        <th>품목</th>
                                        <th>불량(반출) 수량</th>
                                        <th class="text-danger">불량 사유</th>
                                        <th>조치</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in return_logs %}
                                    <tr class="{% if log.is_confirmed %}table-light text-muted{% endif %}">
                                        <td class="small fw-bold">{{ log.delivery_order.order_no }}</td>
                                        <td>{{ log.created_at|date:"Y-m-d" }}</td>
                                        <td>
                                            <span class="fw-bold">{{ log.part.part_no }}</span><br>
                                            <span class="small">{{ log.part.part_name }}</span>
                                        </td>
                                        <td class="fw-bold fs-5">{{ log.quantity|intcomma }} ea</td>
                                        <td>
                                            <span class="badge bg-danger mb-1">수입검사 불합격</span><br>
                                            <small>{{ log.reason|default:"-" }}</small>
                                        </td>
                                        <td>
                                            {% if log.is_confirmed %}
                                                <span class="badge bg-secondary p-2">
                                                    <i class="bi bi-check-all me-1"></i> 확인 완료
                                                </span>
                                                <div class="small text-muted mt-1" style="font-size: 0.75rem;">
                                                    {{ log.confirmed_at|date:"m/d H:i" }}
                                                </div>
                                            {% else %}
                                                <form action="{% url 'confirm_return' log.id %}" method="post" style="display:inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-danger fw-bold"
                                                            onclick="return confirm('부적합 내용을 확인하였으며, 반출 처리에 동의하시겠습니까?\n\n(확인 시 해당 수량만큼 납품 가능 수량이 즉시 복구됩니다)')">
                                                        <i class="bi bi-check2-circle me-1"></i> 반출 확인
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="6" class="text-center py-5 text-muted">부적합/반출 내역이 없습니다.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>
</div>

<div class="card border-primary border-2 shadow-sm mb-5" id="preview-section" style="display: none;">
    <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
        <span><i class="bi bi-cart-plus-fill"></i> 신규 납품서 등록 대기</span>
        <span class="badge bg-white text-primary" id="preview-count">0건</span>
    </div>
    
    <form id="createOrderForm" method="post" action="{% url 'create_delivery_order' %}">
        {% csrf_token %}
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped mb-0 text-center align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 12%;">ERP 정보</th>
                            <th style="width: 12%;">품번</th>
                            <th>품명</th>
                            <th style="width: 8%;">SNP</th>
                            <th style="width: 8%;">박스 수</th>
                            <th style="width: 12%;">LOT 번호(생산일)</th>
                            <th style="width: 10%;">총 수량</th>
                            <th style="width: 8%;">취소</th>
                        </tr>
                    </thead>
                    <tbody id="preview-tbody"></tbody>
                    <tfoot class="table-light fw-bold">
                        <tr>
                            <td colspan="6" class="text-end">등록 합계 수량 :</td>
                            <td class="text-end text-primary fs-5" id="grand-total">0</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="p-3 text-end bg-light border-top">
                <span class="text-muted small me-3">※ 위 품목들로 납품서 번호가 하나 생성됩니다.</span>
                <button type="button" class="btn btn-secondary me-1" onclick="clearPreview()">초기화</button>
                <button type="button" class="btn btn-primary fw-bold px-4" onclick="submitCreateOrder()">
                    <i class="bi bi-check-circle-fill"></i> 납품서 생성(등록)
                </button>
            </div>
        </div>
    </form>
</div>

<div class="alert alert-light border-start border-4 border-success shadow-sm mb-4" id="info-alert">
    <h6 class="alert-heading fw-bold"><i class="bi bi-info-circle-fill text-success"></i> 작업 순서 안내</h6>
    <p class="mb-0 small text-muted">
        1. 하단 목록에서 수량을 입력하고 <strong>[등록추가]</strong>를 누르면 <strong>대기 목록(파란색)</strong>에 담깁니다.<br>
        2. 대기 목록에서 <strong>[납품서 생성]</strong>을 누르면 <strong>상단 목록(검은색)</strong>에 납품서가 만들어집니다.<br>
        3. 상단 목록에서 <strong>[납품서]</strong>를 인쇄하여 제품과 함께 납품하세요.<br>
        4. (관리자 전용) 입고 처리는 좌측 <strong>[입고 관리]</strong> 메뉴에서 진행합니다.
    </p>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered table-hover mb-0 align-middle">
                <thead class="table-light text-center text-nowrap">
                    <tr>
                        <th style="width: 50px;">NO</th>
                        <th style="width: 120px; background-color: #f8f9fa;">ERP 번호</th>
                        <th style="width: 60px; background-color: #f8f9fa;">순번</th>
                        <th style="width: 15%;">품번</th>
                        <th>품명</th>
                        <th style="width: 100px;">납기일</th>
                        <th style="width: 100px;">총 발주</th>
                        <th style="width: 120px;" class="table-primary">납품가능</th>
                        <th style="width: 100px;">SNP</th>
                        <th style="width: 80px;">박스</th>
                        <th style="width: 130px;" class="table-warning">LOT 번호(생산일)</th>
                        <th style="width: 100px;">총 발행</th>
                        <th style="width: 80px;">기능</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in label_data %}
                    <tr id="row-{{ forloop.counter }}">
                        <td class="text-center">{{ forloop.counter }}</td>
                        
                        <td class="text-center text-secondary small">{{ item.erp_no|default:"-" }}</td>
                        <td class="text-center text-secondary small">{{ item.erp_seq|default:"-" }}</td>
                        
                        <td class="fw-bold text-primary" id="pno-{{ forloop.counter }}">{{ item.part_no }}</td>
                        <td id="pname-{{ forloop.counter }}">{{ item.part_name }}</td>
                        <td class="text-center small">{{ item.due_date|date:"m/d" }}</td>
                        <td class="text-end text-muted">{{ item.total_order|intcomma }}</td>
                        
                        <td class="text-end fw-bold fs-5 text-danger remain-cell" id="remain-{{ forloop.counter }}" data-val="{{ item.remain }}">
                            {{ item.remain|intcomma }}
                        </td>
                        
                        <td>
                            <input type="number" class="form-control form-control-sm text-end bg-light"
                                   id="snp-{{ forloop.counter }}" value="0" min="1"
                                   oninput="calculateTotal({{ forloop.counter }})">
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm text-end"
                                   id="box-{{ forloop.counter }}" value="1" min="1"
                                   oninput="calculateTotal({{ forloop.counter }})">
                        </td>
                        <td>
                            <input type="date" class="form-control form-control-sm"
                                   id="lot-no-{{ forloop.counter }}" title="LOT 번호(생산일)">
                        </td>
                        <td class="text-end fw-bold" id="total-{{ forloop.counter }}">0</td>
                        <td class="text-center">
                            <input type="hidden" id="oid-{{ forloop.counter }}" value="{{ item.order_id|default:'' }}">
                            <input type="hidden" id="erp-str-{{ forloop.counter }}" value="{% if item.erp_no != '-' %}{{ item.erp_no }}-{{ item.erp_seq }}{% else %}-{% endif %}">
                            
                            <button type="button" class="btn btn-outline-success btn-sm fw-bold text-nowrap" 
                                    onclick="addToPreview({{ forloop.counter }})">
                                <i class="bi bi-plus-square"></i> 추가
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="12" class="text-center py-5 text-muted">등록된 발주 내역이 없습니다.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // 수량 계산 로직
    function calculateTotal(rowId) {
        var snp = parseInt(document.getElementById('snp-' + rowId).value) || 0;
        var box = parseInt(document.getElementById('box-' + rowId).value) || 0;
        var total = snp * box;
        document.getElementById('total-' + rowId).innerText = total.toLocaleString();
        
        var remain = parseInt(document.getElementById('remain-' + rowId).getAttribute('data-val'));
        var totalElem = document.getElementById('total-' + rowId);
        
        // 잔량 초과 시 붉은색 표시
        if (total > remain) {
            totalElem.classList.add('text-danger');
            totalElem.style.textDecoration = "underline";
        } else {
            totalElem.classList.remove('text-danger');
            totalElem.style.textDecoration = "none";
        }
    }

    var addedItems = []; 

    // 대기 목록에 추가
    function addToPreview(rowId) {
        var partNo = document.getElementById('pno-' + rowId).innerText;
        var partName = document.getElementById('pname-' + rowId).innerText;
        var snp = parseInt(document.getElementById('snp-' + rowId).value) || 0;
        var box = parseInt(document.getElementById('box-' + rowId).value) || 0;
        var total = snp * box;
        var remain = parseInt(document.getElementById('remain-' + rowId).getAttribute('data-val'));

        // [신규] Order ID 및 ERP 정보 가져오기
        var orderId = document.getElementById('oid-' + rowId).value;
        var erpStr = document.getElementById('erp-str-' + rowId).value;

        // [LOT 정보 추가] - 날짜형식으로 통일
        var lotNo = document.getElementById('lot-no-' + rowId).value.trim();

        // 유효성 검사
        if (snp <= 0 || box <= 0) { alert('SNP와 박스 수를 입력해주세요.'); return; }
        if (total > remain) { alert('납품가능 수량을 초과했습니다.'); return; }
        if (!lotNo) { alert('LOT 번호(생산일)를 입력해주세요.'); return; }

        // 중복 방지 키 (같은 품목이라도 LOT가 다르면 별도 등록 가능)
        var itemKey = (orderId ? orderId : partNo) + "_" + snp + "_" + lotNo;

        if (addedItems.indexOf(itemKey) !== -1) {
            alert('이미 대기 목록에 추가된 항목입니다.');
            return;
        }

        // UI 표시
        document.getElementById('preview-section').style.display = 'block';
        document.getElementById('info-alert').style.display = 'none';
        
        var tbody = document.getElementById('preview-tbody');
        var newRow = document.createElement('tr');
        newRow.className = "preview-item-row";
        newRow.id = 'preview-row-' + itemKey.replace(/[^a-zA-Z0-9]/g, '_');
        
        var html = '';
        // [신규] ERP 정보 표시
        html += '<td class="small text-muted">' + erpStr + '</td>';

        html += '<td class="fw-bold text-primary">' + partNo;
        // [핵심] 폼 전송 데이터 생성 (LOT 정보 추가)
        html += '  <input type="hidden" name="part_nos[]" value="' + partNo + '">';
        html += '  <input type="hidden" name="snps[]" value="' + snp + '">';
        html += '  <input type="hidden" name="box_counts[]" value="' + box + '">';
        html += '  <input type="hidden" name="order_ids[]" value="' + orderId + '">'; // Order ID 전송
        html += '  <input type="hidden" name="lot_nos[]" value="' + lotNo + '">';
        html += '  <input type="hidden" class="row-total-val" value="' + total + '">';
        html += '</td>';

        html += '<td>' + partName + '</td>';
        html += '<td>' + snp + '</td>';
        html += '<td>' + box + '</td>';
        html += '<td class="small text-primary fw-bold">' + lotNo + '</td>';
        html += '<td class="preview-total-text fw-bold">' + total.toLocaleString() + '</td>';
        html += '<td>';
        html += '  <button type="button" class="btn btn-sm btn-danger" onclick="removePreview(\'' + itemKey + '\')">';
        html += '    <i class="bi bi-x-lg"></i>';
        html += '  </button>';
        html += '</td>';

        newRow.innerHTML = html;
        tbody.appendChild(newRow);
        addedItems.push(itemKey);
        updateGrandTotal();
    }

    function removePreview(itemKey) {
        var safeId = itemKey.replace(/[^a-zA-Z0-9]/g, '_');
        var element = document.getElementById('preview-row-' + safeId);
        if (element) element.remove();
        addedItems = addedItems.filter(function(item) { return item !== itemKey; });
        updateGrandTotal();
        
        if (addedItems.length === 0) {
            document.getElementById('preview-section').style.display = 'none';
            document.getElementById('info-alert').style.display = 'block';
        }
    }

    function clearPreview() {
        if(confirm('목록을 비우시겠습니까?')) {
            document.getElementById('preview-tbody').innerHTML = '';
            addedItems = [];
            updateGrandTotal();
            document.getElementById('preview-section').style.display = 'none';
            document.getElementById('info-alert').style.display = 'block';
        }
    }

    function updateGrandTotal() {
        var total = 0;
        var inputs = document.querySelectorAll('.row-total-val');
        for (var i = 0; i < inputs.length; i++) {
            total += parseInt(inputs[i].value);
        }
        document.getElementById('grand-total').innerText = total.toLocaleString();
        document.getElementById('preview-count').innerText = addedItems.length + '건';
    }

    function submitCreateOrder() {
        if (addedItems.length === 0) { alert('등록할 품목이 없습니다.'); return; }
        if (confirm('총 ' + addedItems.length + '건으로 납품서를 생성하시겠습니까?')) {
            document.getElementById('createOrderForm').submit();
        }
    }

    function openPrintPopup(orderId) {
        var url = "/label/print/" + orderId + "/"; 
        window.open(url, 'print_popup', 'width=1000,height=900,scrollbars=yes');
    }
    function openNotePopup(orderId) {
        var url = "/label/print_note/" + orderId + "/";
        window.open(url, 'note_popup', 'width=900,height=1000,scrollbars=yes');
    }
</script>
{% endblock %}