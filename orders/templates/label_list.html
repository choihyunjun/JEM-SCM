{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="mb-4 d-flex align-items-center flex-wrap gap-3">
    <div>
        <span class="badge bg-success me-2">협력사 전용</span>
        <span class="fw-bold text-secondary">납품서 등록 및 라벨 발행</span>
    </div>

    {% if user.is_superuser or user.profile.role == 'STAFF' %}
    <div class="d-flex align-items-center gap-2 ms-2">
        <form method="get" class="d-flex align-items-center gap-2">
            <select name="vendor_id" class="form-select form-select-sm shadow-sm" onchange="this.form.submit()" style="width: 180px; border-color: #198754; background-color: #f8fff9;">
                <option value="">== 업체 전체 선택 ==</option>
                {% for v in vendor_list %}
                    <option value="{{ v.id }}" {% if selected_vendor_id == v.id|stringformat:"s" %}selected{% endif %}>
                        {{ v.name }}
                    </option>
                {% endfor %}
            </select>

            <div class="input-group input-group-sm" style="width: 220px;">
                <input type="text" name="q" value="{{ q|default:'' }}" class="form-control border-primary shadow-sm" placeholder="품번 또는 품명 검색">
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-search"></i>
                </button>
            </div>
            
            <input type="hidden" name="status" value="{{ status_filter|default:'' }}">
        </form>

        <form method="get" class="d-flex align-items-center">
            <input type="hidden" name="vendor_id" value="{{ selected_vendor_id|default:'' }}">
            <input type="hidden" name="q" value="{{ q|default:'' }}">
            <select name="status" class="form-select form-select-sm shadow-sm" onchange="this.form.submit()" style="width: 130px; border-color: #0d6efd;">
                <option value="">== 전체 상태 ==</option>
                <option value="registered" {% if status_filter == 'registered' %}selected{% endif %}>등록완료</option>
                <option value="received" {% if status_filter == 'received' %}selected{% endif %}>입고완료</option>
            </select>
        </form>
    </div>
    {% endif %}
</div>

<div class="card border-dark shadow-sm mb-4">
    <div class="card-header bg-dark text-white fw-bold">
        <i class="bi bi-files"></i> 최근 생성된 납품서
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 text-center align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 25%;">납품서 번호</th>
                        <th style="width: 20%;">등록 일시</th>
                        <th style="width: 15%;">포함 품목 수</th>
                        <th style="width: 15%;">상태</th>
                        <th style="width: 25%;">관리</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in recent_orders %}
                    <tr class="{% if order.is_received %}table-success{% endif %}">
                        <td class="fw-bold">{{ order.order_no }}</td>
                        <td>{{ order.created_at|date:"Y-m-d H:i" }}</td>
                        <td>{{ order.items.count }}종</td>
                        <td>
                            {% if order.is_received %}
                                <span class="badge bg-success border border-light rounded-pill px-3 shadow-sm">
                                    <i class="bi bi-check-circle-fill"></i> 입고완료
                                </span>
                            {% else %}
                                <span class="badge bg-secondary rounded-pill px-3">등록완료</span>
                            {% endif %}
                        </td>
                        <td class="text-nowrap">
                            <div style="min-width: 180px;">
                                <button class="btn btn-sm btn-outline-success fw-bold me-1" onclick="openPrintPopup('{{ order.id }}')" style="width: 68px;">
                                    <i class="bi bi-qr-code"></i> 라벨
                                </button>
                                <button class="btn btn-sm btn-outline-primary fw-bold me-1" onclick="openNotePopup('{{ order.id }}')" style="width: 80px;">
                                    <i class="bi bi-file-text"></i> 납품서
                                </button>
                                
                                <div class="d-inline-block" style="width: 35px; vertical-align: middle;">
                                    {% if not order.is_received %}
                                    <form action="{% url 'delete_delivery_order' order.id %}" method="post" onsubmit="return confirm('납품서를 삭제하시겠습니까?');" style="margin: 0;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="납품서 삭제">
                                            <i class="bi bi-trash3"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="py-3 text-muted">조건에 맞는 납품서가 없습니다.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card border-primary border-2 shadow-sm mb-5" id="preview-section" style="display: none;">
    <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
        <span><i class="bi bi-cart-plus-fill"></i> 신규 납품서 등록 대기</span>
        <span class="badge bg-white text-primary" id="preview-count">0건</span>
    </div>
    
    <form id="createOrderForm" method="post" action="{% url 'create_delivery_order' %}">
        {% csrf_token %}
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped mb-0 text-center align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>품번</th>
                            <th>품명</th>
                            <th>SNP</th>
                            <th>박스 수</th>
                            <th>총 수량</th>
                            <th>취소</th>
                        </tr>
                    </thead>
                    <tbody id="preview-tbody"></tbody>
                    <tfoot class="table-light fw-bold">
                        <tr>
                            <td colspan="4" class="text-end">등록 합계 수량 :</td>
                            <td class="text-end text-primary fs-5" id="grand-total">0</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="p-3 text-end bg-light border-top">
                <span class="text-muted small me-3">※ 위 품목들로 납품서 번호가 하나 생성됩니다.</span>
                <button type="button" class="btn btn-secondary me-1" onclick="clearPreview()">초기화</button>
                <button type="button" class="btn btn-primary fw-bold px-4" onclick="submitCreateOrder()">
                    <i class="bi bi-check-circle-fill"></i> 납품서 생성(등록)
                </button>
            </div>
        </div>
    </form>
</div>

<div class="alert alert-light border-start border-4 border-success shadow-sm mb-4" id="info-alert">
    <h6 class="alert-heading fw-bold"><i class="bi bi-info-circle-fill text-success"></i> 작업 순서 안내</h6>
    <p class="mb-0 small text-muted">
        1. 하단 목록에서 수량을 입력하고 <strong>[등록추가]</strong>를 누르면 <strong>대기 목록(파란색)</strong>에 담깁니다.<br>
        2. 대기 목록에서 <strong>[납품서 생성]</strong>을 누르면 <strong>상단 목록(검은색)</strong>에 납품서가 만들어집니다.<br>
        3. 상단 목록에서 <strong>[납품서]</strong>를 인쇄하여 제품과 함께 납품하세요.<br>
        4. (관리자 전용) 입고 처리는 좌측 <strong>[입고 관리]</strong> 메뉴에서 진행합니다.
    </p>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered table-hover mb-0 align-middle">
                <thead class="table-light text-center text-nowrap">
                    <tr>
                        <th style="width: 50px;">NO</th>
                        <th style="width: 15%;">품번</th>
                        <th>품명</th>
                        <th style="width: 120px;">총 발주 수량</th>
                        <th style="width: 150px;" class="table-primary">납품가능 수량</th>
                        <th style="width: 120px;">SNP (박스당)</th>
                        <th style="width: 100px;">박스 수</th>
                        <th style="width: 120px;">총 발행량</th>
                        <th style="width: 80px;">기능</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in label_data %}
                    <tr id="row-{{ forloop.counter }}">
                        <td class="text-center">{{ forloop.counter }}</td>
                        <td class="fw-bold text-primary" id="pno-{{ forloop.counter }}">{{ item.part_no }}</td>
                        <td id="pname-{{ forloop.counter }}">{{ item.part_name }}</td>
                        <td class="text-end text-muted">{{ item.total_order|intcomma }}</td>
                        <td class="text-end fw-bold fs-5 text-danger" id="remain-{{ forloop.counter }}" data-val="{{ item.remain }}">
                            {{ item.remain|intcomma }}
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm text-end bg-light" 
                                   id="snp-{{ forloop.counter }}" value="0" min="1"
                                   oninput="calculateTotal({{ forloop.counter }})">
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm text-end" 
                                   id="box-{{ forloop.counter }}" value="1" min="1"
                                   oninput="calculateTotal({{ forloop.counter }})">
                        </td>
                        <td class="text-end fw-bold" id="total-{{ forloop.counter }}">0</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-outline-success btn-sm fw-bold text-nowrap" 
                                    onclick="addToPreview({{ forloop.counter }})">
                                <i class="bi bi-plus-square"></i> 등록추가
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="10" class="text-center py-5 text-muted">데이터가 없습니다.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function calculateTotal(rowId) {
        const snp = parseInt(document.getElementById('snp-' + rowId).value) || 0;
        const box = parseInt(document.getElementById('box-' + rowId).value) || 0;
        const total = snp * box;
        document.getElementById('total-' + rowId).innerText = total.toLocaleString();
        const remain = parseInt(document.getElementById('remain-' + rowId).getAttribute('data-val'));
        const totalElem = document.getElementById('total-' + rowId);
        if (total > remain) {
            totalElem.classList.add('text-danger');
            totalElem.style.textDecoration = "underline";
        } else {
            totalElem.classList.remove('text-danger');
            totalElem.style.textDecoration = "none";
        }
    }

    let addedItems = []; 

    function addToPreview(rowId) {
        const partNo = document.getElementById('pno-' + rowId).innerText;
        const partName = document.getElementById('pname-' + rowId).innerText;
        const snp = parseInt(document.getElementById('snp-' + rowId).value) || 0;
        const box = parseInt(document.getElementById('box-' + rowId).value) || 0;
        const total = snp * box;
        const remain = parseInt(document.getElementById('remain-' + rowId).getAttribute('data-val'));
        
        const itemKey = partNo + "_" + snp;

        if (snp <= 0 || box <= 0) { alert('SNP와 박스 수를 입력해주세요.'); return; }
        if (total > remain) { alert('잔량을 초과했습니다.'); return; }
        
        if (addedItems.includes(itemKey)) { 
            alert('이미 대기 목록에 동일한 품번과 SNP 수량이 존재합니다.'); 
            return; 
        }

        document.getElementById('preview-section').style.display = 'block';
        document.getElementById('info-alert').style.display = 'none';
        
        const tbody = document.getElementById('preview-tbody');
        const newRow = document.createElement('tr');
        newRow.id = 'preview-row-' + itemKey.replace(/[^a-zA-Z0-9]/g, '_');
        newRow.innerHTML = `
            <td class="fw-bold">${partNo}
                <input type="hidden" name="part_nos[]" value="${partNo}">
                <input type="hidden" name="part_names[]" value="${partName}">
                <input type="hidden" name="snps[]" value="${snp}">
                <input type="hidden" name="box_counts[]" value="${box}">
            </td>
            <td>${partName}</td>
            <td>${snp}</td>
            <td>${box}</td>
            <td class="preview-total fw-bold">${total.toLocaleString()}</td>
            <td>
                <button type="button" class="btn btn-sm btn-danger" onclick="removePreview('${itemKey}')">
                    <i class="bi bi-x-lg"></i>
                </button>
            </td>
        `;
        tbody.appendChild(newRow);
        addedItems.push(itemKey);
        updateGrandTotal();
    }

    function removePreview(itemKey) {
        const safeId = itemKey.replace(/[^a-zA-Z0-9]/g, '_');
        const element = document.getElementById('preview-row-' + safeId);
        if (element) element.remove();
        
        addedItems = addedItems.filter(item => item !== itemKey);
        updateGrandTotal();
        
        if (addedItems.length === 0) {
            document.getElementById('preview-section').style.display = 'none';
            document.getElementById('info-alert').style.display = 'block';
        }
    }

    function clearPreview() {
        if(confirm('목록을 비우시겠습니까?')) {
            document.getElementById('preview-tbody').innerHTML = '';
            addedItems = [];
            updateGrandTotal();
            document.getElementById('preview-section').style.display = 'none';
            document.getElementById('info-alert').style.display = 'block';
        }
    }

    function updateGrandTotal() {
        let total = 0;
        document.querySelectorAll('.preview-total').forEach(td => {
            total += parseInt(td.innerText.replace(/,/g, ''));
        });
        document.getElementById('grand-total').innerText = total.toLocaleString();
        document.getElementById('preview-count').innerText = addedItems.length + '건';
    }

    function submitCreateOrder() {
        if (addedItems.length === 0) { alert('등록할 품목이 없습니다.'); return; }
        if (confirm(`총 ${addedItems.length}건으로 납품서를 생성(등록)하시겠습니까?`)) {
            document.getElementById('createOrderForm').submit();
        }
    }

    function openPrintPopup(orderId) {
        const url = "/label/print/" + orderId + "/"; 
        window.open(url, 'print_popup', 'width=1000,height=900,scrollbars=yes');
    }
    function openNotePopup(orderId) {
        const url = "/label/print_note/" + orderId + "/";
        window.open(url, 'note_popup', 'width=900,height=1000,scrollbars=yes');
    }
</script>
{% endblock %}