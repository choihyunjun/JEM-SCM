{% extends 'base.html' %}
{% load humanize %}
{% load auth_extras %}

{% block content %}
<div class="container-fluid p-0">

    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3 top-control">
        <h2 class="header-title mb-0">
            <i class="bi bi-calendar3 me-2"></i>ì¼ìë³„ ì†Œìš” í˜„í™© (D+14)
            {% if not show_all %}
                <span class="badge bg-info ms-2" style="font-size: 0.7rem; vertical-align: middle;">ì†Œìš” í’ˆëª©ë§Œ í‘œì‹œ ì¤‘</span>
            {% endif %}
        </h2>

        <div class="top-actions">
            {% if user.is_superuser or user|has_perm:'can_scm_inventory_view' %}
            <form method="get" class="control-block" id="searchForm">
                <input type="hidden" name="show_all" value="{{ show_all|lower }}">
                <input type="hidden" name="search" value="1">
                <input type="hidden" name="vendor_id" id="hiddenVendorId" value="{{ selected_vendor_id|default:'' }}">

                <!-- ì—…ì²´ ì„ íƒ ë²„íŠ¼ -->
                <button type="button" class="btn btn-sm btn-outline-secondary shadow-sm" onclick="openVendorSearchModal()" id="vendorSelectBtn">
                    <i class="bi bi-building me-1"></i>
                    {% if selected_vendor_name %}
                    <span id="selectedVendorText">{{ selected_vendor_name }}</span>
                    {% else %}
                    <span id="selectedVendorText">ì „ì²´ ì—…ì²´</span>
                    {% endif %}
                    <i class="bi bi-chevron-down ms-1"></i>
                </button>

                <div class="input-group input-group-sm search-group">
                    <input type="text" name="q" value="{{ q|default:'' }}"
                           class="form-control border-primary shadow-sm" placeholder="í’ˆë²ˆ/í’ˆëª…">
                    <button class="btn btn-primary" type="submit">
                        <i class="bi bi-search me-1"></i>ì¡°íšŒ
                    </button>
                </div>
            </form>
            {% endif %}

            <div class="control-block btn-block">
                <a href="{% url 'inventory_export' %}?show_all={{ show_all|lower }}&vendor_id={{ selected_vendor_id|default:'' }}&q={{ q|default:'' }}"
                   class="btn btn-sm btn-success shadow-sm">
                    <i class="bi bi-file-earmark-excel me-1"></i>ì—‘ì…€ ì €ì¥
                </a>

                {% if user.is_superuser or user|has_perm:'can_scm_inventory_edit' %}
                <a href="{% url 'demand_manage' %}" class="btn btn-sm btn-outline-primary shadow-sm bg-white">
                    <i class="bi bi-pencil-square me-1"></i>ì†Œìš”ëŸ‰ ìˆ˜ì •/ì‚­ì œ
                </a>

                <button class="btn btn-sm btn-warning shadow-sm" onclick="openBulkShortageModal()">
                    <i class="bi bi-cart-plus me-1"></i>ë¶€ì¡±í’ˆ ì¼ê´„ ë°œì£¼
                </button>
                {% endif %}
            </div>

            <div class="control-block toggle-block">
                <div class="btn-group shadow-sm">
                    <a href="?show_all=false&vendor_id={{ selected_vendor_id|default:'' }}&q={{ q|default:'' }}&search=1"
                       class="btn btn-sm {% if not show_all %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        ğŸ“Œ ì†Œìš” í’ˆëª©ë§Œ
                    </a>
                    <a href="?show_all=true&vendor_id={{ selected_vendor_id|default:'' }}&q={{ q|default:'' }}&search=1"
                       class="btn btn-sm {% if show_all %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        ğŸ” ì „ì²´ í’ˆëª©
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% if not search_submitted %}
    <!-- ì¡°íšŒ ì „ ì•ˆë‚´ ë©”ì‹œì§€ -->
    <div class="card shadow-sm border-0">
        <div class="card-body text-center py-5">
            <i class="bi bi-search text-primary" style="font-size: 4rem;"></i>
            <h4 class="mt-3 text-secondary">ì¼ìë³„ ì†Œìš” í˜„í™© ì¡°íšŒ</h4>
            <p class="text-muted mb-4">
                ì—…ì²´ë¥¼ ì„ íƒí•˜ê±°ë‚˜ í’ˆë²ˆ/í’ˆëª…ì„ ê²€ìƒ‰í•œ í›„ <strong class="text-primary">ì¡°íšŒ</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.<br>
                <small>ì•„ë¬´ê²ƒë„ ì…ë ¥í•˜ì§€ ì•Šê³  ì¡°íšŒí•˜ë©´ ì „ì²´ ì—…ì²´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</small>
            </p>
            <div class="d-inline-block text-start bg-light rounded p-3">
                <div class="small text-muted mb-2"><i class="bi bi-lightbulb me-1"></i>ê²€ìƒ‰ íŒ</div>
                <ul class="small mb-0 ps-3">
                    <li>ì—…ì²´ ì„ íƒ: íŠ¹ì • í˜‘ë ¥ì‚¬ì˜ í’ˆëª©ë§Œ ì¡°íšŒ</li>
                    <li>í’ˆë²ˆ/í’ˆëª… ê²€ìƒ‰: í‚¤ì›Œë“œë¡œ í’ˆëª© ê²€ìƒ‰</li>
                    <li>ì†Œìš” í’ˆëª©ë§Œ / ì „ì²´ í’ˆëª©: í‘œì‹œ ë²”ìœ„ ì„ íƒ</li>
                </ul>
            </div>
        </div>
    </div>
    {% else %}
    <!-- ì¡°íšŒ ê²°ê³¼ í…Œì´ë¸” -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 78vh; overflow: auto;">
                <table class="table table-bordered align-middle mb-0" style="font-size: 0.8rem; width: max-content; min-width: 100%;">
                    <thead class="table-light text-center">
                        <tr>
                            <th rowspan="2" style="width: 180px; position: sticky; left: 0; top: 0; z-index: 30;" class="bg-light sticky-col">í’ˆëª© ì •ë³´</th>
                            <th rowspan="2" style="width: 70px; position: sticky; top: 0; z-index: 20;" class="bg-light">êµ¬ë¶„</th>
                            <th rowspan="2" style="width: 90px; position: sticky; top: 0; z-index: 20;" class="bg-light border-end-bold">ì‹œì—…ì¬ê³ </th>
                            {% for dt in date_range %}
                            <th class="date-cell"
                                style="position: sticky; top: 0; z-index: 20; min-width: 85px; {% if dt.weekday >= 5 %}color: #d9534f; background-color: #fff5f5;{% endif %}">
                                {{ dt|date:"m/d" }}<br><small>({{ dt|date:"D" }})</small>
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in inventory_data %}
                        <tr class="text-center">
                            <td rowspan="3" class="text-start ps-3 fw-bold bg-white sticky-col"
                                style="position: sticky; left: 0; z-index: 10; border-right: 2px solid #adb5bd !important;">
                                <div class="text-primary small mb-1">{{ item.vendor_name }}</div>
                                <div class="text-dark">{{ item.part_no }}</div>
                                <div class="small text-secondary fw-normal text-truncate" style="max-width: 150px;">{{ item.part_name }}</div>
                            </td>
                            <td class="bg-light small">ì†Œìš”ëŸ‰</td>
                            <td rowspan="3" class="fw-bold fs-6 border-end-bold bg-white">
                                {{ item.base_stock|intcomma }}
                                <div class="text-muted" style="font-size: 0.6rem;">(ê¸°ì¤€: ì˜¤ëŠ˜ì•„ì¹¨)</div>
                            </td>
                            {% for day in item.daily_status %}
                            <td class="text-primary date-cell {% if user.is_superuser or user.profile.role == 'STAFF' %}cursor-pointer hover-bg-light{% endif %}"
                                style="min-width: 85px;"
                                {% if user.is_superuser or user.profile.role == 'STAFF' %}onclick="editDemand('{{ item.part_no }}', '{{ day.date|date:'Y-m-d' }}', '{{ day.demand_qty }}')"{% endif %}>
                                {% if day.demand_qty > 0 %}{{ day.demand_qty|intcomma }}{% else %}-{% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        <tr class="text-center">
                            <td class="bg-light small">ì…ê³ ëŸ‰</td>
                            {% for day in item.daily_status %}
                            <td class="text-success date-cell" style="min-width: 85px;">
                                {% if day.in_qty > 0 %}{{ day.in_qty|intcomma }}{% else %}-{% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        <tr class="text-center border-bottom-bold">
                            <td class="bg-light small fw-bold">ê³¼ë¶€ì¡±</td>
                            {% for day in item.daily_status %}
                            <td class="fw-bold date-cell {% if user.is_superuser or user.profile.role == 'STAFF' %}cursor-pointer hover-bg-light{% endif %} {% if day.is_danger %}bg-danger-light text-danger{% endif %}"
                                style="min-width: 85px;"
                                {% if user.is_superuser or user.profile.role == 'STAFF' %}
                                    onclick="openOrderModal('{{ item.part_no }}', '{{ item.part_name|escapejs }}', '{{ item.vendor_name|escapejs }}', '{{ day.stock|stringformat:'d' }}', '{{ day.date|date:'Y-m-d' }}')"
                                    title="í´ë¦­í•˜ì—¬ ë°œì£¼ ìƒì„±"
                                {% endif %}>
                                {{ day.stock|intcomma }}
                                {% if day.is_danger and user.is_superuser or user.profile.role == 'STAFF' %}
                                    <i class="bi bi-plus-circle-fill ms-1" style="font-size: 0.7rem;"></i>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if search_submitted %}
<div style="position: fixed; bottom: 25px; right: 35px; z-index: 9999;">
    <div class="shadow-lg border p-2" style="background-color: #212529; color: white; border-radius: 8px; font-size: 0.9rem; border-color: #495057;">
        <i class="bi bi-info-circle text-info me-1"></i>
        ê¸°ì´ˆì¬ê³  ì—…ë¡œë“œ ì¼ì :
        <span class="text-warning fw-bold ms-1" style="text-shadow: 1px 1px 1px rgba(0,0,0,0.5);">
            {% if inventory_ref_date %}{{ inventory_ref_date|date:"Y-m-d" }}{% else %}ë¯¸ë“±ë¡{% endif %}
        </span>
    </div>
</div>
{% endif %}

<!-- ì—…ì²´ ê²€ìƒ‰ ëª¨ë‹¬ -->
<div class="modal fade" id="vendorSearchModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white py-2">
                <h6 class="modal-title"><i class="bi bi-building me-2"></i>ì—…ì²´ ì„ íƒ</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <input type="text" id="vendorModalSearchInput" class="form-control form-control-lg"
                       placeholder="ì—…ì²´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" autofocus>
                <div id="vendorModalList" class="mt-2" style="max-height: 250px; overflow-y: auto;">
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-search fs-3 d-block mb-2"></i>
                        ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤
                    </div>
                </div>
            </div>
            <div class="modal-footer py-2 justify-content-between">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="selectVendorFromModal('', 'ì „ì²´ ì—…ì²´')">
                    <i class="bi bi-x-circle me-1"></i>ì„ íƒ í•´ì œ (ì „ì²´ ì—…ì²´)
                </button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">ë¶€ì¡±ë¶„ ë°œì£¼ ìƒì„±</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="quickOrderForm" method="post" action="{% url 'quick_order_action' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">í’ˆëª© ì •ë³´</label>
                        <div id="modalPartInfo" class="p-2 bg-light rounded small"></div>
                        <input type="hidden" name="vendor_name" id="hiddenVendor">
                        <input type="hidden" name="part_no" id="hiddenPartNo">
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label fw-bold text-danger">í˜„ ì¬ê³ (ê³¼ë¶€ì¡±)</label>
                            <input type="text" id="modalShortage" class="form-control" readonly>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label fw-bold">ë°œì£¼ ìˆ˜ëŸ‰</label>
                            <input type="number" name="quantity" id="modalOrderQty" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">ë‚©ê¸° ìš”ì²­ì¼</label>
                        <input type="date" name="due_date" id="modalDueDate" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary w-100 fw-bold">ë¯¸í™•ì¸ ë°œì£¼ë¡œ ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="bulkShortageModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title fw-bold"><i class="bi bi-cart-plus me-2"></i>ë¶€ì¡±í’ˆ ì¼ê´„ ë°œì£¼</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="bulkShortageForm" method="post" action="{% url 'bulk_shortage_order' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <!-- ì—…ì²´ í•„í„° ì˜ì—­ (ì„ íƒì‚¬í•­) -->
                    <div class="mb-3">
                        <div class="d-flex align-items-center gap-2">
                            <label class="form-label fw-bold mb-0"><i class="bi bi-funnel me-1"></i>ì—…ì²´ í•„í„°</label>
                            <span class="text-muted small">(ì„ íƒì‚¬í•­)</span>
                        </div>
                        <div class="d-flex gap-2 mt-2">
                            <div class="position-relative flex-grow-1">
                                <input type="text" id="vendorSearchInput" class="form-control form-control-sm"
                                       placeholder="í˜‘ë ¥ì‚¬ëª… ê²€ìƒ‰..." autocomplete="off">
                                <div id="vendorSearchResults" class="list-group position-absolute w-100 shadow"
                                     style="z-index: 1050; max-height: 250px; overflow-y: auto; display: none;"></div>
                            </div>
                            <div id="selectedVendorDisplay" style="display: none;">
                                <span class="badge bg-primary px-3 py-2">
                                    <span id="selectedVendorName"></span>
                                    <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.5rem;" onclick="clearSelectedVendor()"></button>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- ë¶€ì¡±í’ˆ í…Œì´ë¸” ì˜ì—­ -->
                    <div id="shortageTableContainer">
                        <div class="alert alert-info py-2 mb-3">
                            <i class="bi bi-info-circle me-1"></i>
                            <span id="vendorShortageInfo"></span>
                        </div>
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-bordered table-sm align-middle mb-0" style="font-size: 0.85rem;">
                                <thead class="table-light text-center sticky-top">
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" id="checkAll" checked></th>
                                        <th style="width: 120px;">ì—…ì²´</th>
                                        <th style="width: 150px;">í’ˆë²ˆ</th>
                                        <th style="width: 90px;">ë¶€ì¡±ì¼</th>
                                        <th style="width: 90px;">ë¶€ì¡±ìˆ˜ëŸ‰</th>
                                        <th style="width: 120px;">ë‚©ê¸°ìš”ì²­ì¼</th>
                                        <th style="width: 100px;">ë°œì£¼ìˆ˜ëŸ‰</th>
                                    </tr>
                                </thead>
                                <tbody id="shortageTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ë¶€ì¡±í’ˆ ì—†ìŒ ë©”ì‹œì§€ -->
                    <div id="noShortageMessage" class="text-center text-muted py-5" style="display: none;">
                        <i class="bi bi-check-circle-fill text-success fs-1 d-block mb-2"></i>
                        ë¶€ì¡± í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                </div>
                <div class="modal-footer">
                    <span class="me-auto text-muted small" id="selectedCount">ì„ íƒ: 0ê±´</span>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-warning fw-bold" id="bulkOrderSubmitBtn" disabled>
                        <i class="bi bi-check-lg me-1"></i>ì„ íƒ í’ˆëª© ë°œì£¼ ë“±ë¡
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function editDemand(partNo, date, currentQty) {
    const newQty = prompt(`${date}ì˜ ì†Œìš”ëŸ‰ì„ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì‚­ì œí•˜ë ¤ë©´ 0ì„ ì…ë ¥í•˜ì„¸ìš”)`, currentQty);
    if (newQty !== null && !isNaN(newQty) && newQty.trim() !== "") {
        const formData = new FormData();
        formData.append('part_no', partNo);
        formData.append('due_date', date);
        formData.append('quantity', newQty);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        fetch("{% url 'demand_update_ajax' %}", { method: 'POST', body: formData })
        .then(response => { if (response.ok) { location.reload(); } else { alert("ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); } });
    }
}

function openOrderModal(partNo, partName, vendor, shortage, dueDate) {
    document.getElementById('modalPartInfo').innerHTML = `<strong>${vendor}</strong><br>${partNo} | ${partName}`;
    document.getElementById('hiddenVendor').value = vendor;
    document.getElementById('hiddenPartNo').value = partNo;
    document.getElementById('modalShortage').value = shortage;
    const shortageInt = parseInt(shortage);
    document.getElementById('modalOrderQty').value = shortageInt < 0 ? Math.abs(shortageInt) : 0;
    document.getElementById('modalDueDate').value = dueDate;
    new bootstrap.Modal(document.getElementById('orderModal')).show();
}

// ë¶€ì¡±í’ˆ ì¼ê´„ ë°œì£¼ ê´€ë ¨ í•¨ìˆ˜
const shortageData = [];
{% for item in inventory_data %}
    {% for day in item.daily_status %}
        {% if day.is_danger %}
        shortageData.push({
            vendor: '{{ item.vendor_name|escapejs }}',
            partNo: '{{ item.part_no|escapejs }}',
            partName: '{{ item.part_name|escapejs }}',
            shortageDate: '{{ day.date|date:"Y-m-d" }}',
            shortageQty: {{ day.stock }},
            dueDate: '{{ day.date|date:"Y-m-d" }}'
        });
        {% endif %}
    {% endfor %}
{% endfor %}

// í’ˆë²ˆ+ì—…ì²´ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µ ì œê±° (ì²« ë²ˆì§¸ ë¶€ì¡±ì¼ë§Œ ì‚¬ìš©)
const uniqueShortages = [];
const seenKeys = new Set();
shortageData.forEach(item => {
    const key = item.partNo + '_' + item.vendor;
    if (!seenKeys.has(key)) {
        seenKeys.add(key);
        uniqueShortages.push(item);
    }
});

// ë¶€ì¡±í’ˆì´ ìˆëŠ” ì—…ì²´ ëª©ë¡ ì¶”ì¶œ
const vendorsWithShortage = [...new Set(uniqueShortages.map(item => item.vendor))].sort();

// ì´ë¯¸ ë“±ë¡ëœ ë¯¸í™•ì¸ ë°œì£¼ ëª©ë¡ (í’ˆë²ˆ_ë‚©ê¸°ì¼ í˜•íƒœ) - ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš°
const pendingOrderKeys = new Set([
    {% for key in pending_order_keys %}'{{ key }}',{% endfor %}
]);
// ë¯¸í™•ì¸ ë°œì£¼ê°€ ìˆëŠ” í’ˆë²ˆ ëª©ë¡ (ë‚ ì§œ ë¬´ê´€) - ê´€ë ¨ ë°œì£¼ ê²½ê³ ìš©
const pendingOrderParts = new Set([
    {% for part in pending_order_parts %}'{{ part }}',{% endfor %}
]);

let selectedVendorForBulk = null;

function openBulkShortageModal() {
    // ì´ˆê¸°í™”
    selectedVendorForBulk = null;
    document.getElementById('vendorSearchInput').value = '';
    document.getElementById('vendorSearchInput').style.display = 'block';
    document.getElementById('vendorSearchResults').style.display = 'none';
    document.getElementById('selectedVendorDisplay').style.display = 'none';

    // ì „ì²´ ë¶€ì¡±í’ˆ í‘œì‹œ
    showShortages(null);

    new bootstrap.Modal(document.getElementById('bulkShortageModal')).show();
}

// ì—…ì²´ ê²€ìƒ‰ ê¸°ëŠ¥
let vendorSearchTimeout = null;
const vendorSearchInput = document.getElementById('vendorSearchInput');
const vendorSearchResults = document.getElementById('vendorSearchResults');

// Enter í‚¤ë¡œ í¼ ì œì¶œ ë°©ì§€ (ê²€ìƒ‰ì°½ì—ì„œ)
vendorSearchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        // ê²€ìƒ‰ ê²°ê³¼ê°€ ë³´ì´ë©´ ì²« ë²ˆì§¸ í•­ëª© ì„ íƒ
        const firstResult = vendorSearchResults.querySelector('.list-group-item-action');
        if (firstResult && vendorSearchResults.style.display !== 'none') {
            firstResult.click();
        }
    }
});

vendorSearchInput.addEventListener('input', function() {
    clearTimeout(vendorSearchTimeout);
    const query = this.value.trim().toLowerCase();

    if (query.length < 1) {
        vendorSearchResults.style.display = 'none';
        return;
    }

    vendorSearchTimeout = setTimeout(() => {
        vendorSearchResults.innerHTML = '';
        const filtered = vendorsWithShortage.filter(v => v.toLowerCase().includes(query));

        if (filtered.length === 0) {
            vendorSearchResults.innerHTML = '<div class="list-group-item text-muted">ë¶€ì¡±í’ˆì´ ìˆëŠ” í˜‘ë ¥ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        } else {
            filtered.forEach(vendor => {
                const count = uniqueShortages.filter(s => s.vendor === vendor).length;
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                item.innerHTML = `<strong>${vendor}</strong><span class="badge bg-danger">${count}ê±´ ë¶€ì¡±</span>`;
                item.onclick = () => selectVendorForBulk(vendor);
                vendorSearchResults.appendChild(item);
            });
        }
        vendorSearchResults.style.display = 'block';
    }, 200);
});

function selectVendorForBulk(vendor) {
    selectedVendorForBulk = vendor;
    document.getElementById('selectedVendorName').textContent = vendor;
    document.getElementById('selectedVendorDisplay').style.display = 'inline-block';
    document.getElementById('vendorSearchInput').style.display = 'none';
    vendorSearchResults.style.display = 'none';

    // í•´ë‹¹ ì—…ì²´ì˜ ë¶€ì¡±í’ˆë§Œ í‘œì‹œ
    showShortages(vendor);
}

function clearSelectedVendor() {
    selectedVendorForBulk = null;
    document.getElementById('selectedVendorDisplay').style.display = 'none';
    document.getElementById('vendorSearchInput').style.display = 'block';
    document.getElementById('vendorSearchInput').value = '';

    // ì „ì²´ ë¶€ì¡±í’ˆ ë‹¤ì‹œ í‘œì‹œ
    showShortages(null);
}

// ë‚ ì§œ ë¬¸ìì—´ì—ì„œ Nì¼ ì „/í›„ ë‚ ì§œ ê³„ì‚° (YYYY-MM-DD í˜•ì‹ ìœ ì§€)
function calcDate(dateStr, offsetDays) {
    const parts = dateStr.split('-');
    const d = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]) + offsetDays);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
}

function showShortages(vendorFilter) {
    const tbody = document.getElementById('shortageTableBody');
    const noMsg = document.getElementById('noShortageMessage');
    const container = document.getElementById('shortageTableContainer');
    tbody.innerHTML = '';

    // vendorFilterê°€ nullì´ë©´ ì „ì²´, ìˆìœ¼ë©´ í•´ë‹¹ ì—…ì²´ë§Œ
    const shortages = vendorFilter
        ? uniqueShortages.filter(item => item.vendor === vendorFilter)
        : uniqueShortages;

    if (shortages.length === 0) {
        container.style.display = 'none';
        noMsg.style.display = 'block';
        document.getElementById('bulkOrderSubmitBtn').disabled = true;
        document.getElementById('selectedCount').textContent = 'ì„ íƒ: 0ê±´';
    } else {
        container.style.display = 'block';
        noMsg.style.display = 'none';

        // ì´ë¯¸ ë°œì£¼ ë“±ë¡ëœ í’ˆëª© ìˆ˜ ê³„ì‚° (ì •í™• ë§¤ì¹­ + ê´€ë ¨ ë°œì£¼)
        let exactMatchCount = 0;
        let relatedCount = 0;
        shortages.forEach(item => {
            const dueDate = calcDate(item.shortageDate, -1);
            const dk = `${item.partNo}_${dueDate}`;
            if (pendingOrderKeys.has(dk)) {
                exactMatchCount++;
            } else if (pendingOrderParts.has(item.partNo)) {
                relatedCount++;
            }
        });

        let infoHtml = vendorFilter
            ? `<strong>${vendorFilter}</strong> ë¶€ì¡± í’ˆëª© <strong>${shortages.length}</strong>ê±´`
            : `ì „ì²´ ë¶€ì¡± í’ˆëª© <strong>${shortages.length}</strong>ê±´ (${vendorsWithShortage.length}ê°œ ì—…ì²´)`;

        if (exactMatchCount > 0) {
            infoHtml += ` <span class="text-info">| ë°œì£¼ì¤‘ ${exactMatchCount}ê±´</span>`;
        }
        if (relatedCount > 0) {
            infoHtml += ` <span class="text-warning">| ê´€ë ¨ë°œì£¼ ${relatedCount}ê±´</span>`;
        }
        document.getElementById('vendorShortageInfo').innerHTML = infoHtml;

        shortages.forEach((item, idx) => {
            const absQty = Math.abs(item.shortageQty);
            // ë‚©ê¸°ìš”ì²­ì¼ = ë¶€ì¡±ì¼ í•˜ë£¨ ì „
            const dueDate = calcDate(item.shortageDate, -1);

            // ë°œì£¼ ìƒíƒœ í™•ì¸
            const orderKey = `${item.partNo}_${dueDate}`;
            const hasExactMatch = pendingOrderKeys.has(orderKey);  // ì •í™•íˆ ê°™ì€ ë‚©ê¸°ì¼ ë°œì£¼ ì¡´ì¬
            const hasRelatedOrder = !hasExactMatch && pendingOrderParts.has(item.partNo);  // ë‹¤ë¥¸ ë‚©ê¸°ì¼ ë°œì£¼ ì¡´ì¬

            const row = document.createElement('tr');
            if (hasExactMatch) {
                row.classList.add('table-secondary');
            } else if (hasRelatedOrder) {
                row.classList.add('table-warning');
            }

            // ë°°ì§€ ê²°ì •
            let badge = '';
            if (hasExactMatch) {
                badge = '<span class="badge bg-info ms-1" title="ë™ì¼ ë‚©ê¸°ì¼ ë°œì£¼ ì§„í–‰ì¤‘">ë°œì£¼ì¤‘</span>';
            } else if (hasRelatedOrder) {
                badge = '<span class="badge bg-warning text-dark ms-1" title="ì´ í’ˆë²ˆì— ë‹¤ë¥¸ ë‚©ê¸°ì¼ ë°œì£¼ ìˆìŒ">ê´€ë ¨ë°œì£¼</span>';
            }

            row.innerHTML = `
                <td class="text-center">
                    <input type="checkbox" class="shortage-check" data-idx="${idx}" ${hasExactMatch ? '' : 'checked'}>
                </td>
                <td class="small">${item.vendor}</td>
                <td class="fw-bold">
                    ${item.partNo}
                    ${badge}
                </td>
                <td class="text-center">${item.shortageDate}</td>
                <td class="text-center text-danger fw-bold">${item.shortageQty.toLocaleString()}</td>
                <td class="text-center">
                    <input type="date" name="due_date_${idx}" value="${dueDate}" class="form-control form-control-sm">
                </td>
                <td>
                    <input type="number" name="qty_${idx}" value="${absQty}" min="1"
                           class="form-control form-control-sm text-end" style="width: 100px;">
                </td>
                <input type="hidden" name="vendor_${idx}" value="${item.vendor}">
                <input type="hidden" name="part_no_${idx}" value="${item.partNo}">
            `;
            tbody.appendChild(row);
        });

        document.getElementById('checkAll').checked = true;
        updateSelectedCount();
    }
}

function updateSelectedCount() {
    const checks = document.querySelectorAll('.shortage-check:checked');
    document.getElementById('selectedCount').textContent = `ì„ íƒ: ${checks.length}ê±´`;
    document.getElementById('bulkOrderSubmitBtn').disabled = checks.length === 0;
}

document.addEventListener('change', function(e) {
    if (e.target.classList.contains('shortage-check') || e.target.id === 'checkAll') {
        if (e.target.id === 'checkAll') {
            document.querySelectorAll('.shortage-check').forEach(cb => cb.checked = e.target.checked);
        }
        updateSelectedCount();
    }
});

document.getElementById('bulkShortageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    const orders = [];
    document.querySelectorAll('.shortage-check:checked').forEach(cb => {
        const idx = cb.dataset.idx;
        orders.push({
            vendor: document.querySelector(`input[name="vendor_${idx}"]`).value,
            part_no: document.querySelector(`input[name="part_no_${idx}"]`).value,
            due_date: document.querySelector(`input[name="due_date_${idx}"]`).value,
            quantity: document.querySelector(`input[name="qty_${idx}"]`).value
        });
    });

    if (orders.length === 0) {
        alert('ë°œì£¼í•  í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
        return;
    }

    formData.append('orders', JSON.stringify(orders));

    fetch('{% url "bulk_shortage_order" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.created}ê±´ì˜ ë°œì£¼ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            location.reload();
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    })
    .catch(err => {
        alert('ë°œì£¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
});

// ì™¸ë¶€ í´ë¦­ ì‹œ ì—…ì²´ ê²€ìƒ‰ ê²°ê³¼ ë‹«ê¸° (ì¼ê´„ ë°œì£¼ ëª¨ë‹¬ìš©)
document.addEventListener('click', function(e) {
    if (vendorSearchInput && vendorSearchResults) {
        if (!vendorSearchInput.contains(e.target) && !vendorSearchResults.contains(e.target)) {
            vendorSearchResults.style.display = 'none';
        }
    }
});

// ========== ì—…ì²´ ê²€ìƒ‰ ëª¨ë‹¬ ê¸°ëŠ¥ ==========
const allVendors = [
    {% for v in vendor_list %}
    { id: '{{ v.id }}', name: '{{ v.name|escapejs }}' },
    {% endfor %}
];

let vendorSearchModal = null;

function openVendorSearchModal() {
    if (!vendorSearchModal) {
        vendorSearchModal = new bootstrap.Modal(document.getElementById('vendorSearchModal'));
    }

    // ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
    const input = document.getElementById('vendorModalSearchInput');
    input.value = '';
    document.getElementById('vendorModalList').innerHTML = `
        <div class="text-center text-muted py-4">
            <i class="bi bi-search fs-3 d-block mb-2"></i>
            ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤
        </div>`;

    vendorSearchModal.show();

    // ëª¨ë‹¬ ì—´ë¦° í›„ ê²€ìƒ‰ì°½ì— í¬ì»¤ìŠ¤
    setTimeout(() => input.focus(), 300);
}

let vendorSearchDebounce = null;

function renderVendorList(query) {
    const listContainer = document.getElementById('vendorModalList');
    const q = query.trim().toLowerCase();

    // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€
    if (q.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="bi bi-search fs-3 d-block mb-2"></i>
                ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤
            </div>`;
        return;
    }

    // 1ê¸€ìë©´ ë” ì…ë ¥ ì•ˆë‚´
    if (q.length < 2) {
        listContainer.innerHTML = '<div class="text-center text-muted py-3">2ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”</div>';
        return;
    }

    // ê²€ìƒ‰ ì‹¤í–‰
    const filtered = allVendors.filter(v => v.name.toLowerCase().includes(q)).slice(0, 10);

    if (filtered.length === 0) {
        listContainer.innerHTML = '<div class="text-center text-muted py-3"><i class="bi bi-emoji-frown me-1"></i>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }

    listContainer.innerHTML = '';
    filtered.forEach(vendor => {
        const item = document.createElement('button');
        item.type = 'button';
        item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
        // ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŠ¸
        const highlighted = vendor.name.replace(new RegExp(`(${q})`, 'gi'), '<strong class="text-primary">$1</strong>');
        item.innerHTML = `<span><i class="bi bi-building me-2 text-muted"></i>${highlighted}</span><i class="bi bi-chevron-right text-muted"></i>`;
        item.onclick = () => selectVendorFromModal(vendor.id, vendor.name);
        listContainer.appendChild(item);
    });

    // ë” ë§ì€ ê²°ê³¼ê°€ ìˆìœ¼ë©´ í‘œì‹œ
    const totalMatched = allVendors.filter(v => v.name.toLowerCase().includes(q)).length;
    if (totalMatched > 10) {
        const moreDiv = document.createElement('div');
        moreDiv.className = 'text-center text-muted small py-2 border-top';
        moreDiv.textContent = `ì™¸ ${totalMatched - 10}ê±´ ë” ìˆìŒ (ê²€ìƒ‰ì–´ë¥¼ ë” ì…ë ¥í•˜ì„¸ìš”)`;
        listContainer.appendChild(moreDiv);
    }
}

function selectVendorFromModal(vendorId, vendorName) {
    document.getElementById('hiddenVendorId').value = vendorId;
    document.getElementById('selectedVendorText').textContent = vendorName;

    // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½ (ì„ íƒë¨ í‘œì‹œ)
    const btn = document.getElementById('vendorSelectBtn');
    if (vendorId) {
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-primary');
    } else {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-secondary');
    }

    if (vendorSearchModal) {
        vendorSearchModal.hide();
    }
}

// ëª¨ë‹¬ ë‚´ ê²€ìƒ‰ ì…ë ¥ ì´ë²¤íŠ¸ (debounce ì ìš©)
document.getElementById('vendorModalSearchInput')?.addEventListener('input', function() {
    clearTimeout(vendorSearchDebounce);
    const val = this.value;
    vendorSearchDebounce = setTimeout(() => renderVendorList(val), 150);
});

// Enter í‚¤ë¡œ ì²« ë²ˆì§¸ ê²°ê³¼ ì„ íƒ
document.getElementById('vendorModalSearchInput')?.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const firstItem = document.querySelector('#vendorModalList .list-group-item-action');
        if (firstItem) firstItem.click();
    }
});
</script>

<style>
/* âœ… ìƒë‹¨ ì»¨íŠ¸ë¡¤ ê°„ê²© ê°•ì œ ì¡°ì • */
.top-actions{
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 14px;
}
.control-block{
    display: flex;
    align-items: center;
    gap: 8px;
}
.btn-block{ gap: 6px; }
.toggle-block{ margin-left: 4px; }
.search-group{ width: 220px; }

/* ì—…ì²´ ì„ íƒ ë²„íŠ¼ */
#vendorSelectBtn {
    min-width: 140px;
    text-align: left;
}

/* ì—…ì²´ ê²€ìƒ‰ ëª¨ë‹¬ ë¦¬ìŠ¤íŠ¸ */
#vendorModalList .list-group-item-action {
    padding: 10px 15px;
    cursor: pointer;
    border-left: none;
    border-right: none;
}
#vendorModalList .list-group-item-action:hover {
    background-color: #e3f2fd;
}
.top-control .btn,
.top-control .form-select,
.top-control .form-control{
    height: 32px;
}

/* ê¸°ì¡´ ìŠ¤íƒ€ì¼ */
.table { table-layout: auto !important; }
.table-bordered th, .table-bordered td { border: 1px solid #dee2e6 !important; padding: 8px 4px !important; white-space: nowrap; }
.table thead th { background-color: #f8f9fa !important; box-shadow: inset 0 -1px 0 #dee2e6; }
.sticky-col { box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
.header-title { font-size: 1.2rem; font-weight: 700; color: #2c3e50; }
.border-end-bold { border-right: 2px solid #adb5bd !important; }
.border-bottom-bold { border-bottom: 2px solid #dee2e6 !important; }
.bg-danger-light { background-color: #fff5f5 !important; transition: 0.2s; }
.cursor-pointer { cursor: pointer; }
</style>

{% endblock %}
