{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="container-fluid p-0" style="max-width: 1920px;">

    <!-- 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-4 pt-3">
        <div>
            <h4 class="fw-bold mb-1" style="color: #c00000;">
                <i class="bi bi-graph-up-arrow me-2"></i>협력사 납기준수율 분석
            </h4>
            <p class="text-muted mb-0 small">월별/기간별 납기준수 현황을 분석합니다.</p>
        </div>
        {% if is_month_closed and not is_range_mode %}
            <span class="badge bg-success fs-6 px-3 py-2">
                <i class="bi bi-lock-fill me-1"></i> {{ selected_month }} 마감 완료
            </span>
        {% endif %}
    </div>

    <!-- 기간 선택 필터 -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body py-3">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-auto">
                    <label class="small text-muted mb-1">시작 월</label>
                    <select name="start_month" class="form-select form-select-sm" style="min-width: 140px;">
                        {% for m in month_list %}
                            <option value="{{ m.value }}" {% if start_month == m.value %}selected{% endif %}>
                                {{ m.label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-auto">
                    <label class="small text-muted mb-1">종료 월</label>
                    <select name="end_month" class="form-select form-select-sm" style="min-width: 140px;">
                        {% for m in month_list %}
                            <option value="{{ m.value }}" {% if end_month == m.value %}selected{% endif %}>
                                {{ m.label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-auto">
                    <label class="small text-muted mb-1">협력사 검색</label>
                    <input type="text" name="vendor_search" class="form-control form-control-sm"
                           style="min-width: 180px;" placeholder="업체명/코드 검색"
                           value="{{ vendor_search|default:'' }}">
                </div>
                <div class="col-auto">
                    <button class="btn btn-primary btn-sm px-4" type="submit">
                        <i class="bi bi-search me-1"></i> 조회
                    </button>
                    <a href="{% url 'vendor_delivery_report' %}" class="btn btn-outline-secondary btn-sm">초기화</a>
                </div>

                <!-- 마감 버튼 (관리자 & 단일 월 & 마감 가능) -->
                {% if can_close and user.is_staff and not is_range_mode %}
                <div class="col-auto ms-auto">
                    <button type="button" class="btn btn-danger btn-sm px-4" data-bs-toggle="modal" data-bs-target="#closeMonthModal">
                        <i class="bi bi-lock-fill me-1"></i> {{ selected_month }} 월 마감
                    </button>
                </div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- 조회 기간 표시 -->
    <div class="alert alert-light border mb-4 py-2">
        <i class="bi bi-calendar-range me-2"></i>
        <strong>조회 기간:</strong> {{ start_month }} ~ {{ end_month }}
        {% if is_range_mode %}
            <span class="badge bg-info ms-2">누적 실적</span>
        {% endif %}
    </div>

    <!-- 요약 카드 섹션 -->
    <div class="row g-3 mb-4">
        <!-- 전체 납기준수율 -->
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm" style="border-left: 5px solid #0d6efd !important;">
                <div class="card-body">
                    <div class="small text-muted mb-1">전체 납기준수율</div>
                    <div class="display-5 fw-bold text-primary">{{ total_compliance_rate }}%</div>
                    <div class="small text-muted mt-2">
                        입고 {{ total_incoming_qty|intcomma }}개 기준
                    </div>
                </div>
            </div>
        </div>

        <!-- 발주 대비 입고율 -->
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm" style="border-left: 5px solid #6f42c1 !important;">
                <div class="card-body">
                    <div class="small text-muted mb-1">발주 대비 입고율</div>
                    <div class="display-5 fw-bold" style="color: #6f42c1;">{{ total_incoming_rate }}%</div>
                    <div class="small text-muted mt-2">
                        발주 {{ total_order_qty|intcomma }} / 입고 {{ total_incoming_qty|intcomma }}
                    </div>
                </div>
            </div>
        </div>

        <!-- 납기 준수 수량 -->
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm" style="border-left: 5px solid #198754 !important;">
                <div class="card-body">
                    <div class="small text-muted mb-1">납기 내 입고</div>
                    <div class="display-5 fw-bold text-success">{{ total_on_time_qty|intcomma }}</div>
                    <div class="small text-success mt-2">
                        <i class="bi bi-check-circle-fill me-1"></i>정상 입고 수량
                    </div>
                </div>
            </div>
        </div>

        <!-- 납기 지연 수량 -->
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm" style="border-left: 5px solid #dc3545 !important;">
                <div class="card-body">
                    <div class="small text-muted mb-1">납기 지연/미입고</div>
                    <div class="display-5 fw-bold text-danger">{{ total_delayed_qty|intcomma }}</div>
                    <div class="small text-danger mt-2">
                        <i class="bi bi-exclamation-triangle-fill me-1"></i>지연 + 미입고 수량
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 등급 분포 카드 -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body py-3">
            <div class="row align-items-center">
                <div class="col-auto">
                    <span class="fw-bold text-dark"><i class="bi bi-award me-2"></i>협력사 등급 분포</span>
                </div>
                <div class="col-auto">
                    <span class="badge bg-success me-2 px-3 py-2">A등급 (95%+): {{ grade_a }}개사</span>
                    <span class="badge bg-warning text-dark me-2 px-3 py-2">B등급 (85-95%): {{ grade_b }}개사</span>
                    <span class="badge bg-danger px-3 py-2">C등급 (85%-): {{ grade_c }}개사</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 협력사별 상세 테이블 -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h6 class="fw-bold mb-0">
                <i class="bi bi-building me-2"></i>협력사별 납기준수율 상세
                {% if is_month_closed %}
                    <span class="badge bg-success ms-2">마감 데이터</span>
                {% else %}
                    <span class="badge bg-secondary ms-2">실시간</span>
                {% endif %}
            </h6>
            <span class="text-muted small">총 {{ vendor_stats|length }}개 협력사</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle" style="font-size: 0.9rem;">
                    <thead class="table-light">
                        <tr class="text-center">
                            <th style="width: 4%;">순위</th>
                            <th style="width: 14%;" class="text-start">협력사</th>
                            <th style="width: 10%;">발주수량</th>
                            <th style="width: 10%;">입고수량</th>
                            <th style="width: 8%;">입고율</th>
                            <th style="width: 10%;">납기준수</th>
                            <th style="width: 10%;">납기지연</th>
                            <th style="width: 14%;">준수율</th>
                            <th style="width: 8%;">평균 L/T</th>
                            <th style="width: 8%;">등급</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in vendor_stats %}
                        <tr class="text-center">
                            <td class="text-muted">{{ forloop.counter }}</td>
                            <td class="text-start fw-bold">{{ stat.vendor.name }}</td>
                            <td>{{ stat.order_qty|intcomma }}</td>
                            <td class="fw-bold">{{ stat.incoming_qty|intcomma }}</td>
                            <td>
                                <span class="{% if stat.incoming_rate >= 100 %}text-success{% elif stat.incoming_rate >= 80 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ stat.incoming_rate }}%
                                </span>
                            </td>
                            <td class="text-success fw-bold">{{ stat.on_time_qty|intcomma }}</td>
                            <td class="text-danger fw-bold">{{ stat.delayed_qty|intcomma }}</td>
                            <td>
                                <div class="d-flex align-items-center justify-content-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 8px; max-width: 80px;">
                                        <div class="progress-bar
                                            {% if stat.compliance_rate >= 95 %}bg-success
                                            {% elif stat.compliance_rate >= 85 %}bg-warning
                                            {% else %}bg-danger{% endif %}"
                                            style="width: {{ stat.compliance_rate }}%;">
                                        </div>
                                    </div>
                                    <span class="fw-bold">{{ stat.compliance_rate }}%</span>
                                </div>
                            </td>
                            <td>{{ stat.avg_lead_time }}일</td>
                            <td>
                                {% if stat.compliance_rate >= 95 %}
                                    <span class="badge bg-success px-3 py-2">A</span>
                                {% elif stat.compliance_rate >= 85 %}
                                    <span class="badge bg-warning text-dark px-3 py-2">B</span>
                                {% else %}
                                    <span class="badge bg-danger px-3 py-2">C</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="10" class="text-center text-muted py-5">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                해당 월에 발주/입고 데이터가 없습니다.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 안내 문구 -->
    <div class="mt-3 text-end">
        <small class="text-muted">
            <i class="bi bi-info-circle me-1"></i>
            * 분석 기준: 해당 월 납기 도래 발주 기준 | 납기준수율 = 납기 내 입고수량 / (납기 내 입고 + 납기지연/미입고)
        </small>
    </div>
</div>

<!-- 월 마감 확인 모달 -->
{% if can_close %}
<div class="modal fade" id="closeMonthModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-lock-fill me-2"></i>월 마감 확인</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="bi bi-exclamation-triangle-fill text-warning display-4 mb-3 d-block"></i>
                <h5 class="fw-bold mb-3">{{ selected_month }} 실적을 마감하시겠습니까?</h5>
                <p class="text-muted mb-0">
                    마감 후에는 데이터가 고정되며,<br>
                    이후 발주/입고 변경이 반영되지 않습니다.
                </p>
                <div class="alert alert-info mt-3 mb-0 text-start small">
                    <i class="bi bi-info-circle me-1"></i>
                    <strong>마감 대상:</strong> {{ vendor_stats|length }}개 협력사<br>
                    <strong>전체 준수율:</strong> {{ total_compliance_rate }}%
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <form method="post" action="{% url 'vendor_delivery_close_month' %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="year_month" value="{{ selected_month }}">
                    <button type="submit" class="btn btn-danger px-4">
                        <i class="bi bi-lock-fill me-1"></i> 마감 확정
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
